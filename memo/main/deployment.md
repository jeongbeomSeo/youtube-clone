# Deployment

- [Deployment](#deployment)
  - [1. Set-Up](#1-set-up)
  - [2. Heroku](#2-heroku)
  - [3. MongoDB Atlas](#3-mongodb-atlas)
  - [4. Modify Code](#4-modify-code)
  - [4. AWS](#4-aws)

## 1. Set-Up

ì´ì œ ìš°ë¦¬ ì„œë²„ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë‚¨ë“¤ë„ ë‹¤ ë³¼ìˆ˜ ìˆê²Œë” ë°°í¬ë¥¼ í•´ë³¼ ê²ƒì´ë‹¤.

í˜„ì¬ ìš°ë¦¬ëŠ” production Modeê°€ ì•„ë‹ˆë¼ Deployment Modeë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸°ë„ í•˜ê³ , í˜„ì¬ ì €ì¥ë˜ëŠ” Videoë‚˜ Avatarê°™ì€ ìë£Œë“¤ì´ ìš°ë¦¬ ì»´í“¨í„°ì— ì €ì¥ë˜ê³  ìˆë‹¤. ë˜í•œ, DBë„ ìš°ë¦¬ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìƒíƒœë‹¤.

ì´ëŸ¬í•œ ê²ƒë“¤ì„ ìˆ˜ì •í•˜ê³  ë°°í¬ë¥¼ ì§„í–‰í•´ ë³¼ ê²ƒì´ë‹¤.

ë¨¼ì € ìš°ë¦¬ê°€ ë°°í¬í•  ë•Œ ì‚¬ìš©í•  ê²ƒì€ **Heroku**ì´ë‹¤.

> **Herokuë€?**
>
> HerokuëŠ” Java, Node.js, Pythonë“± ì—¬ëŸ¬ ì–¸ì–´ë¥¼ ì§€ì›í•˜ëŠ” í´ë¼ìš°ë“œ Passì´ë‹¤.

> **Passë€?**
>
> ì„œë¹„ìŠ¤í˜• í”Œë«í¼(Platform as a Service, PaaS)ì€ í´ë¼ìš°ë“œ ì»´í“¨íŒ… ì„œë¹„ìŠ¤ ë¶„ë¥˜ ì¤‘ í•˜ë‚˜ë‹¤.
> ì¼ë°˜ì ìœ¼ë¡œ ì•±ì„ ê°œë°œí•˜ê±°ë‚˜ êµ¬í˜„í•  ë•Œ, ê´€ë ¨ ì¸í”„ë¼ë¥¼ ë§Œë“¤ê³  ìœ ì§€ ë³´ìˆ˜í•˜ëŠ” ë³µì¡í•¨ ì—†ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ê°œë°œ, ì‹¤í–‰, ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” í”Œë«í¼ì„ ì œê³µí•œë‹¤. SaaS(Software-as-a-Service)ì˜ ê°œë…ì„ ê°œë°œ í”Œë«í¼ì—ë„ í™•ì¥í•œ ë°©ì‹ìœ¼ë¡œ, ê°œë°œì„ ìœ„í•œ í”Œë«í¼ì„ êµ¬ì¶œí•  í•„ìš” ì—†ì´, í•„ìš”í•œ ê°œë°œ ìš”ì†Œë¥¼ ì›¹ì—ì„œ ì‰½ê²Œ ë¹Œë ¤ì“¸ ìˆ˜ ìˆê²Œ í•˜ëŠ” ëª¨ë¸ì´ë‹¤.

Herokuì— ë°°í¬ë¥¼í•˜ê¸° ì „ì— node.jsí™˜ê²½ì„ ë°”ê¿”ì¤˜ì•¼ í•˜ê³ , DBë„ ë°”ê¿”ì£¼ë©´ì„œ, íŒŒì¼ë“¤ì„ ì•„ë§ˆì¡´ì— ì˜¬ë ¤ì¤„ ê²ƒì´ë‹¤.

ë¨¼ì €, ìš°ë¦¬ì˜ ì½”ë“œë¥¼ Deployment ë°©ì‹ìœ¼ë¡œ ë¹Œë“œí•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, **production ë°©ì‹ìœ¼ë¡œ ë¹Œë“œí•˜ì—¬, ì½”ë“œë¥¼ ì••ì¶•(modify)í•´ì•¼ í•œë‹¤.**

ë¨¼ì € í•´ì•¼í•  ê²ƒì€ **í˜„ì¬ ìš°ë¦¬ê°€ ë§Œë“  ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ nodemonì„ ì‚¬ìš©í•´ì„œ babel-nodeë¥¼ ì‹¤í–‰í•´ì•¼ í•œë‹¤.**

babel-nodeëŠ” ì‹¤ì œë¡œ ì„œë¹„ìŠ¤ ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ê°œë°œí•  ë•Œë§Œ ì‚¬ìš©í•˜ëŠ” ëª©ì ìœ¼ë¡œ ì‚¬ìš©í•œë‹¤.

> babel-nodeëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ES6ë¥¼ ì´ìš©í•´ì„œ ì½”ë”©ì„ í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ê²ƒì´ë‹¤.
>
> babel-nodeë¥¼ ì‚¬ìš©í•˜ë©´ performance ë¬¸ì œê°€ ìˆëŠ”ë°, babel-nodeëŠ” ë¹ ë¥´ì§€ ì•Šë‹¤.

ê·¸ë˜ì„œ ìš°ë¦¬ëŠ” ì½”ë“œë¥¼ ì¼ë°˜ì ì¸ javascriptì½”ë“œë¡œ ë°”ê¿”ì¤˜ì•¼ í•œë‹¤.

ê·¸ë•Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ Babel CLIì´ë‹¤.

    npm install --save-dev @babel/core @babel/cli

ì„¤ì¹˜ë¥¼ í•œ í›„, package.jsonìœ¼ë¡œ ê°€ì„œ "scripts"ì— í•´ë‹¹ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ì.

    "build:server": "babel src -d build",

fileì„ ë¹Œë“œí•˜ëŠ” ê²ƒì¸ë° srcì— ìˆëŠ” ëª¨ë“  íŒŒì¼ë“¤ì„ ë¹Œë“œí•  ê²ƒì´ê³ , -dëŠ” íŠ¹ì • directoryë¥¼ ì§€ì •í•˜ëŠ” ê²ƒìœ¼ë¡œ buildí´ë”ì— ë¹Œë“œë¥¼ í•  ê²ƒì´ë‹¤.

> buildí´ë”ì˜ ê²½ìš° .gitignoreì— ë„£ì–´ì£¼ì.

ì´ì œ "scripts"ì— "start"ë¼ëŠ” ëª…ë ì–´ë¥¼ ì¶”ê°€í•  ê²ƒì´ë‹¤.

ë¹Œë“œëœ init.jsë¥¼ ì‹¤í–‰í•  ê²ƒì´ë‹¤.

    "start": "node build/init.js",

ì‹¤í–‰ ê²°ê³¼ ë‘ ê°€ì§€ ì˜¤ë¥˜ê°€ ìˆë‹¤.

![npmStart-Error](./screenshot/npmStart-Error.png)

1.  regeneratorRuntimeì´ ì •ì˜ë˜ì§€ ì•Šì•˜ë‹¤.
2.  srcë¥¼ ë¹Œë“œí–ˆëŠ”ë° ê·¸ ì¤‘ í´ë” í•˜ë‚˜ê°€ ì—†ë‹¤.

ë¨¼ì € ì²« ë²ˆì§¸ ì˜¤ë¥˜ëŠ” Recorder Chapterì—ì„œë„ ë´¤ë“¯ì´, Frontendì—ì„œ asyncì™€ awaitë¥¼ ì‚¬ìš©í•˜ë ¤ê³  í•  ë•Œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ë‹¤.

ë‘ ë²ˆì§¸ ì˜¤ë¥˜ëŠ” buildí´ë”ì— pugíŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.

ë¨¼ì € ì²«ë²ˆì§¸ ì˜¤ë¥˜ë¥¼ ê³ ì¹˜ê¸° ìœ„í•´ì„œ ì„œë²„ì—ì„œ ì‚¬ìš©í•˜ê³  ìˆë˜ init.jsì— regenerator-runtimeì„ importí•´ì£¼ì.

    import "regenerator-runtime";

> **npm startë¡œ ì…ë ¥í•´ë„ ì‹¤í–‰ëœë‹¤.**
>
> ê·¸ ì´ìœ ëŠ” npm startê°€ ê¸°ë³¸ ëª…ë ì–´ì´ê¸° ë•Œë¬¸ì´ë‹¤.

ê·¸ë¦¬ê³  ë‘ ë²ˆì§¸ ì˜¤ë¥˜ë¥¼ ë³´ì.

ì™œ viewsí´ë”ê°€ buildí´ë”ì— ì—†ëŠ” ê²ƒì¼ê¹Œ?

ê·¸ ì´ìœ ëŠ” server.jsì— ìˆë‹¤.

viewsë¥¼ ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì„ ë³´ë©´,

    app.set("views", process.cwd() + "/src/views");

ì´ì™€ ê°™ì´ ë˜ì–´ ìˆë‹¤.

> process.cwd()ëŠ” í˜„ì¬ working directoryì—ì„œ nodeë¥¼ ì‹¤í–‰í•œ í´ë” ìœ„ì¹˜ë¥¼ ë§í•œë‹¤.
>
> package.jsonì´ ìˆëŠ” í´ë”ë¥¼ ì˜ë¯¸í•˜ê³ , rootí´ë”ë¼ê³ ë„ ë§í•œë‹¤.

build í´ë” ë°–ì— ìœ„ì¹˜í•˜ê³  ìˆê³ , src í´ë”ì˜ ë°”ê¹¥ì´ë‹¤.

buildì˜ backendê°€ ì§ì ‘ /src/viewsë¡œ ì´ë™í–ˆê¸° ë•Œë¬¸ì— viewsí´ë”ë¥¼ ì˜®ê¸°ì§€ ì•Šì•„ë„ ëœë‹¤.

**ì¦‰, buildí´ë” ì•ˆì— viewsí´ë”ê°€ ì—†ì–´ë„ ë¬¸ì œ ì—†ë‹¤.**

ì´ì œ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œë¥¼ ë¹Œë“œí•´ì•¼ í•œë‹¤.

webpackì—ëŠ” ë‘ê°€ì§€ ëª¨ë“œê°€ ìˆëŠ”ë°,

**development**ì™€ **production**ëª¨ë“œê°€ ìˆë‹¤.

productionì½”ë“œê°€ í›¨ì”¬ ë” ì‘ë‹¤.

ê·¸ë˜ì„œ assetsì„ ì´ìš©í•˜ì—¬ ë¹Œë“œí•´ë³´ì.

webpack.config.jsì— ìˆë˜ modeë¥¼ ì§€ìš°ê³  package.jsonì— ì ì–´ì£¼ë©´ì„œ ì‹¤í–‰ê³¼ ë™ì‹œì— modeë¥¼ ì„¤ì •í•˜ë„ë¡ í•´ë†“ì.

package.json

```json
...
    "build:assets": "webpack --mode=production",
    "dev:assets": "webpack --mode=development"
...
```

ì—¬ê¸°ì„œ build:assetsì„ í•˜ë©´ ì¢…ë£Œê°€ ë˜ì§€ì•Šê³  ê³„ì†í•´ì„œ ì‹¤í–‰ë˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì™œ ê·¸ëŸ´ê¹Œ?

ìš°ë¦¬ëŠ” developmentë¥¼ ì´ìš©í•˜ë©´ì„œ clientì½”ë“œê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°”ë€ŒëŠ” ê²ƒì„ ëŒ€ì‘í•˜ê¸° ìœ„í•´ watch Modeë¥¼ ì¼œë†¨ë‹¤. ì´ê²ƒì„ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤.

webpack.config.jsì—ì„œ watchë¶€ë¶„ì„ ì§€ì›Œì£¼ê³ , package.jsonê°€ì„œ "scripts"ì— ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì.

    "dev:assets": "webpack --mode=development -w"

ì´ì œ production-readyëœ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¥¼ ì–»ì—ˆë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ buildëª…ë ¹ì–´ë¥¼ í•©ì¹˜ì.

    "build": "npm run build:server && npm run build:assets",

## 2. Heroku

ì´ì œ ìš°ë¦¬ ì„œë²„ë¥¼ Herokuì— ì˜¬ë¦´ ê²ƒì´ë‹¤.

ë¨¼ì € Herokuì—ì„œ ê³„ì •ì„ ë§Œë“¤ê³  dashboardì— ìƒˆë¡œìš´ appì„ ë§Œë“¤ ê²ƒì´ë‹¤.

ë‹¤ìŒ ìˆœì„œë¡œ ì§„í–‰í•´ì£¼ì.

1.  Herokuí™ˆí˜ì´ì§€ì—ì„œ ê³„ì •ì„ ìƒì„±
2.  create new appì„ ëˆŒëŸ¬ì„œ appì„ ë§Œë“¤ê¸°

ì´ê²ƒì´ ì™„ë£Œë˜ë©´, Herokuì— ì´ì œ ë°±ì—”ë“œ ì„œë²„ë¥¼ ì—…ë¡œë“œ í•  ê²ƒì¸ë° ë‘ ê°€ì§€ ë°©ì‹ì´ ìˆë‹¤.

í•˜ë‚˜ëŠ” **Github**, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” **Heroku Git**ì„ ì´ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

í•„ìëŠ” Githubë‘ Herokuê°€ ì—°ë™ì´ ì•ˆë˜ì—ˆê¸°ì— **Heroku Gitë§Œ ì´ìš©í•´ì„œ ì—…ë¡œë“œë¥¼ ì§„í–‰**í–ˆë‹¤.

Heroku Gitìœ¼ë¡œ ë°°í¬í•˜ê¸° ìœ„í•´ì„œ Heroku CLIë¥¼ ì„¤ì¹˜í•´ì•¼ í•œë‹¤.

í˜„ì¬ ìš°ë¶„íˆ¬ë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ë‹¤ìŒ commandë¥¼ ì…ë ¥í•´ì„œ ë‹¤ìš´ë¡œë“œ í•˜ì˜€ë‹¤.

    curl https://cli-assets.heroku.com/install.sh | sh

ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ë³´ì.

    heroku login

ì…ë ¥í•˜ë©´ ì•„ë¬´í‚¤ë‚˜ ëˆ„ë¥´ê±°ë‚˜ që¥¼ ëˆŒëŸ¬ì„œ ì¢…ë£Œí•˜ë¼ê³  ëœ¨ê³  ë§Œì•½ ì•„ë¬´í‚¤ë‚˜ ì…ë ¥í–ˆì„ ê²½ìš° ë¸Œë¼ìš°ì €ê°€ ëœ¨ë©´ì„œ Log in ì°½ì´ ë³´ì¼ ê²ƒì´ë‹¤. ëˆŒëŸ¬ì„œ ì§„í–‰í•˜ë©´ ë‹¤ìŒ í™”ë©´ì´ ë‚˜ì˜¨ë‹¤.

![Heroku-logIn](./screenshot/Heroku-logIn.png)

ì´ì œ ë‚´ ì„œë²„ë¥¼ ë°°í¬í•´ ë³¼ ê²ƒì¸ë°, ì´ë•Œ **git repository**ê°€ í•„ìš”í•˜ë‹¤.

ë§Œì•½, git repositoryê°€ ì—†ë‹¤ë©´ git initì„ í•´ì£¼ì.

ê·¸ í›„, remoteëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ ì—°ê²°í•´ì£¼ë©´ ëœë‹¤.

    heroku git:remote -a wetube-beom

ì—¬ê¸°ì„œ wetube-beomìë¦¬ì—ëŠ” ë³¸ì¸ì˜ ì•± ì´ë¦„ì„ ì ì–´ì£¼ë©´ ëœë‹¤.

> ë§Œì•½ ì½”ë“œë¥¼ ë°”ê¾¸ê³  commitì„ í•˜ì§€ ì•ŠëŠ” ë‹¤ë©´ HerokuëŠ” ìˆ˜ì •ëœ ì½”ë“œë¥¼ ë³¼ ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì— ì£¼ì˜í•˜ì.

> gitì´ ë³¼ ìˆ˜ ìˆëŠ” ì½”ë“œë§Œ Herokuê°€ ë³¼ ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤.

ì´ì œ ë§¤í¬í•´ì£¼ë©´ ë˜ëŠ”ë° ê·¸ ì „ì—, Herokuì˜ ìƒíƒœë¥¼ í™•ì¸í•´ë³´ì.

    heroku logs --tail

--tailì€ ì‹¤ì‹œê°„ logë¥¼ ë³´ì—¬ì¤€ë‹¤.

![heroku-logs-tail-notUpload](./screenshot/heroku-logs-tail-notUpload.png)

ì´ê²Œ í˜„ì¬ ë‚´ heroku ì„œë²„ì´ê³ , ì•„ì§ ì•„ë¬´ê²ƒë„ ì—†ëŠ” ìƒíƒœì´ë‹¤.

ì´ì œ ë°°í¬í•˜ê³ ë‚˜ì„œ í™•ì¸í•´ ë³´ì.

    git push heroku master

![Heroku-upload-firstError](./screenshot/heroku-upload-firstError.png)

í˜„ì¬ ìŠ¤í¬ë¦°ìƒ·ì„ ë³´ë©´ Errorê°€ ì¡´ì¬í•œë‹¤.

**startëª…ë ¹ì–´ ì¡°ì°¨ ëª»ì°¾ê² ë‹¤ê³  ì¨ìˆë‹¤.**

ë¬´ì—‡ì´ ë¬¸ì œì¼ê¹Œ??

ì´ê²ƒì€ ë‚´ê°€ ì ì€ buildëª…ë ¹ì´ gitì— ì—†ê¸° ë•Œë¬¸ì´ë‹¤.

ì—¬ê¸°ì„œ êµ‰ì¥íˆ ìœ ìš”í•œ ê¸°ëŠ¥ì„ í™•ì¸í•  ìˆ˜ ìˆëŠ”ë°,

VsCodeë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë©”ë‰´ê°€ ìˆë‹¤.

![vscode-menu](./screenshot/vscode-menu.png)

ì—¬ê¸°ì„œ **ì„¸ ë²ˆì¨° Menu**ì¸ **Source Control**ì„ ë³´ë©´ **ì–´ë–¤ ë¶€ë¶„ì´ ë³€ê²½ë˜ì—ˆê³ , ì–´ë–»ê²Œ gitì— ì˜¬ë¼ê°”ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.**

![source-control-checking](./screenshot/source-control-checking.png)

ì™¼ìª½ì´ í˜„ì¬ ë‚´ íŒŒì¼ì˜ ë²„ì „ì´ë‹¤.

í˜„ì¬ ì´ íŒŒì¼ì„ herokuê°€ ë³´ê³  ìˆëŠ” ê²ƒì´ë‹¤.

ë³´í†µ ì½”ë“œë¥¼ ìˆ˜ì •í•´ì„œ herokuì— ë°°í¬í• í…ë° ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ë§ë‹¤. ì™œëƒë©´ **ë³€ê²½ë§Œìœ¼ë¡  ë¶€ì¡±í•˜ê¸° ë•Œë¬¸ì´ë‹¤.**

commitì„ í•´ì¤˜ì•¼ í•˜ëŠ” ê²ƒì´ë‹¤.

![git-and-heroku-push-master](./git-and-heroku-push-master.png)

ì´ë ‡ê²Œ í•˜ê³  ë‚˜ë‹ˆ buildëŠ” ë˜ì—ˆëŠ”ë° logë¥¼ í™•ì¸í•´ë³´ë‹ˆ ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë‚˜ì™”ë‹¤.

![fail-client-initialize](./screenshot/fail-client-initialize.png)

ì˜¤ë¥˜ë¥¼ ë³´ë©´ Assertion failedë¡œ,

mongoUrlì´ë‚˜ clientPromiseë‚˜ clientë¥¼ ì¤˜ì•¼ í•œë‹¤ê³  ì í˜€ìˆë‹¤.

ìœ„ì—ì„œ ë§í–ˆë‹¤ì‹œí”¼ **herokuê°€ ë³´ëŠ” ëª¨ë“  íŒŒì¼ì€ Githubê°€ ë³´ëŠ” íŒŒì¼ì´ë‹¤.**

DBì˜ urlì€ process.env.DB_URLì„ ì‚¬ìš©í•œë‹¤.

ë¬¸ì œëŠ” **í˜„ì¬ ìš°ë¦¬ëŠ” .envë¥¼ .gitignore**ì— ë„£ì–´ë†“ì•˜ë‹¤.

ê·¸ëŸ¬ë©´ .envíŒŒì¼ì„ ì—…ë¡œë“œ í•´ì•¼í• ê¹Œ? ì•„ë‹ˆë‹¤. ì ˆëŒ€ í•˜ë©´ ì•ˆë˜ëŠ” ì§“ì´ë‹¤.

ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?

Herokuì—ì„œ ì§€ì›í•˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

**Herokuì˜ admin panelì„ ì‚¬ìš©**í•  ê²ƒì´ë‹¤.

Herokuë¡œ ê°€ì„œ ì„œë²„ì— ë“¤ì–´ê°„ ë‹¤ìŒ settingsë¡œ ê°€ì„œ

![heroku-admin-panel](./screenshot/heroku-admin-panel.png)

ì´ê²ƒì„ ëˆ„ë¥´ë©´ Keyì™€ Valueë¥¼ ì…ë ¥í•˜ëŠ” ì¹¸ì´ ë³´ì´ê³  ì¶”ê°€í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

ê·¸ë˜ì„œ Herokuê°€ ì‹¤í–‰ ë  ë•Œ í•´ë‹¹ Keyê°€ ì½”ë“œì— ìˆìœ¼ë©´ ì ì–´ë†¨ë˜ valueë¥¼ ë°›ì„ ê²ƒì´ë‹¤.

envì— ìˆëŠ” ê²ƒë“¤ì„ ì „ë¶€ ë„£ì–´ì£¼ë„ë¡ í•˜ì.

## 3. MongoDB Atlas

ì´ì œ mongoDB Atlas ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì.

ì—¬ê¸°ì„œ MongoDB ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ì.

1.  ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê¸°
2.  clusterë¥¼ ì¶”ê°€(**clusterëŠ” database groupê³¼ ê°™ì€ ê²ƒ**)
3.  MongoDBì˜ native driverë¥¼ ì‚¬ìš©í•´ì„œ ì•±ê³¼ ì—°ê²°.

3ë²ˆ ê¹Œì§€ ì§„í–‰í•˜ë©´ Connect your applicationì´ ë³´ì´ê³  í´ë¦­í•˜ë©´ URLì´ ë³´ì¼ ê²ƒì´ë‹¤.

ì´ê²ƒì´ DB_URLì´ ë  ê²ƒì´ë‹¤.

ì´ê²ƒì„ Herokuì™€ ì—°ê²°í•´ì¤„ ê²ƒì´ë‹¤.

![heroku-DBUrl](./screenshot/heroku-DBUrl.png)

ì—¬ê¸°ì„œ ë³´ì´ëŠ” URLì„ Herokuì— ë³€ìˆ˜ ë„£ëŠ” ê³³ì— ë„£ì–´ì£¼ë©´ ë˜ê³ , ì—¬ê¸°ì„œ íŒ¨ìŠ¤ì›Œë“œëŠ” MongoDB Atlasì—ì„œ clusterë¥¼ ë§Œë“¤ë•Œ ë‚˜ì™”ë˜ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì ì–´ì£¼ë©´ ëœë‹¤.

> ì°¸ê³ ë¡œ <>(êº½ì‡  í‘œì‹œ)ëŠ” ì§€ì›Œì¤˜ì•¼ í•œë‹¤.

logë¥¼ ì¼œë‘” ìƒíƒœë¼ë©´ ì„±ê³µì ìœ¼ë¡œ DB_URLì´ ì„¤ì •ë˜ì—ˆë‹¤ëŠ” ë©”ì„¸ì§€ë¥¼ ë°›ì„ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

![Set-DBUrl-Config](./screenshot/Set-DBUrl-Config.png)

## 4. Modify Code

ì¶”ê°€ì ìœ¼ë¡œ ìˆ˜ì •í•´ì•¼ ë  ê²ƒì€, **Herokuë¡œ ì‹¤í–‰í•  ë•ŒëŠ” Herokuì—ì„œ ì£¼ëŠ” Portë¡œ ì„œë²„ë¥¼ ì—´ì–´ì•¼ ëœë‹¤ëŠ” ë¶€ë¶„ì´ë‹¤.**

ê·¸ë˜ì„œ ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ì.

    const PORT = process.env.PORT || 4000;

ë˜, githubë¡œê·¸ì¸ì„ ì‹¤í–‰í•˜ë‹ˆ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

ë¬´ìŠ¨ ë¬¸ì œì¸ê°€ ë´¤ë”ë‹ˆ ë˜ëŒì•„ì˜¤ëŠ” Callback Urlì´ ë‹¤ìŒê³¼ ê°™ë‹¤.

    http://localhost:4000/users/github/finish?code=ec02f51e25839a409a06

í˜„ì¬ ìš°ë¦¬ëŠ” githubì—ì„œ settingí•´ë‘” Callback Urlì´ ì´ì™€ ê°™ë‹¤. ê·¸ë˜ì„œ ì´ ë¶€ë¶„ë„ ìˆ˜ì •ì„ í•´ì¤˜ì•¼ í•œë‹¤.

![github-callback-url-modify](./screenshot/github-callback-url-modify.png)

ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•´ì¤„ ê²ƒì¸ë°, ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•´ì£¼ì.

    https://wetube-beom.herokuapp.com/users/github/finish

> ì—¬ê¸°ì„œ wetube-beom.herokuapp.comì´ë¶€ë¶„ì€ Heroku appìœ¼ë¡œ ì‹¤í–‰í–ˆì„ ê²½ìš° ëœ¨ëŠ” urlì´ë‹¤.

> ë¬¸ì œê°€ í•˜ë‚˜ ìˆëŠ”ë°, ë‚´ ì„œë²„ë¡œ ì‹¤í–‰í•  ë•ŒëŠ” Portê°€ 4000ìœ¼ë¡œ í•  ê²ƒì´ë¼ì„œ ë‚´ ì„œë²„ë¡œ ì‹¤í–‰í•´ì„œ githubë¡œ ë¡œê·¸ì¸ì„ í•˜ë ¤ê³  í•˜ë©´ githubí˜ì´ì§€ê°€ì„œ Callback Urlì„ ìˆ˜ì •í•´ì¤˜ì•¼ í•œë‹¤. ë²ˆê±°ë¡­ì§€ë§Œ ì–´ì©” ìˆ˜ ì—†ëŠ” ë¶€ë¶„ì´ë‹¤.

ìœ„ì˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ APPì„ ë‘ê°œ ë§Œë“¤ê¸°ë„ í•œë‹¤.

ìš”ë²ˆì—” Heroku Appì„ ì´ìš©í•´ì„œ Avatarë¥¼ ì—…ë¡œë“œ í•´ë³´ë‹ˆ íŒŒì¼ì´ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.

ë¬´ìŠ¨ ë¬¸ì œì¸ê°€ í•´ì„œ ê°œë°œì ë„êµ¬ë¡œ ì‚¬ì§„ì˜ Urlì„ í™•ì¸í•´ ë³´ë‹ˆ ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ë˜ì–´ìˆì—ˆë‹¤.

    /https://wetube-beom.herokuapp.com/1231231241242353

ë’¤ì— urlì€ ì„ì˜ë¡œ ì ì—ˆë‹¤. ì¤‘ìš”í•œ ê²ƒì€ ì—¬ê¸°ì„œ ì•ì— ìŠ¬ë˜ì‹œê°€ ë¶™ëŠ” ê²ƒì´ë‹¤.

ì½”ë“œë¥¼ ìˆ˜ì •í•´ì¤„ í•„ìš”ê°€ ìˆë‹¤.

ì´ ë¶€ë¶„ì€ **ì•„ë˜ì—ì„œ ë°°ìš°ëŠ” ê¸°ëŠ¥(NODE_ENV)** ìœ¼ë¡œ í•´ê²°ì´ ë  ê²ƒì´ë‹¤. ë’¤ì—ì„œ í™•ì¸í•˜ì.

## 4. AWS

ì´ì œ íŒŒì¼ì„ ì €ì¥í•˜ê¸° ìœ„í•´ì„œ AWSë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤.

ë¨¼ì € AWS ê³„ì •ì„ ìƒì„±í•´ì£¼ì.

ê·¸ í›„ Service -> Storage -> S3ìœ¼ë¡œ ì´ë™í•œ í›„ **bucketì„ ë§Œë“¤ì–´ ì£¼ì.**

create bucketì„ ëˆ„ë¥´ë©´ bucket nameì„ ì§€ìœ¼ë¼ê³  ëœ¬ë‹¤. ì´ë•Œ ê³ ìœ ëª…ì´ì—¬ì•¼ í•œë‹¤.

![Create-AWS-Bucket](./screenshot/Create-AWS-Bucket.png)

Bucketìƒì„±ê¹Œì§„ ë˜ì—ˆë‹¤. ì´ì  **API keyë¥¼ ë§Œë“¤ì–´ì¤„ ì°¨ë¡€**ì´ë‹¤.

1.  ê²€ìƒ‰ì°½ì— IAMì„ ì³ì„œ ì´ë™í•˜ì.
2.  Add Userë¥¼ í´ë¦­ -> user name ì¶”ê°€
3.  Programmatic access í´ë¦­ (ì´ê²ƒì„ í•˜ì§€ ì•Šìœ¼ë©´ ì›¹ì‚¬ì´íŠ¸ì— ë¡œê·¸ì¸ í•  ë•Œë§ˆë‹¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•œë‹¤.)

> ì´ê±´ ë¡œê·¸ì¸ í•  ë•Œ access keyë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì¸ë°, key IDì™€ secret Keyì´ë‹¤. ê·¸ë˜ì„œ Node.jsì„œë²„ê°€ ë¡œê·¸ì¸ í•  ìˆ˜ ìˆë‹¤.

4. Next Permissionì„ í´ë¦­

> ì—¬ê¸°ì„  ì–´ë–¤ ê¶Œí•œì´ë“  ì¤„ ìˆ˜ ìˆëŠ” í˜ì´ì§€ê°€ ë‚˜ì˜¨ë‹¤.
>
> ì—¬ê¸°ì„œ ë§Œì•½, AdministratorAccessë¥¼ ëˆŒëŸ¬ì„œ í—ˆìš©í•œë‹¤ë©´ ì´ keyë¥¼ ëˆ„êµ°ê°€ ì–»ìœ¼ë©´ ë‚´ ê³„ì •ìœ¼ë¡œ ë­ë“ ì§€ í•  ìˆ˜ ìˆëŠ”ê²ƒ. ë¬¼ë¡ , í´ë¦­í•˜ì§€ ì•Šì„ ê²ƒì´ë‹¤.

5. s3ë¥¼ ê²€ìƒ‰í•´ì„œ íŒŒì¼ì— ëŒ€í•´ì„œë§Œ S3ì—ì„œ í•  ìˆ˜ ìˆëŠ” ëª¨ë“  ê¶Œí•œì„ ì£¼ëŠ” AmazonS3FullAccess í—ˆìš©
6. Next:tag í´ë¦­ ( tagëŠ” ë¶™ì¼ í•„ìš” ì—†ìœ¼ë‹ˆ Pass)
7. Reviewí˜ì´ì§€ì—ì„œ ì˜ ì„¤ì •ë¬ëŠ”ì§€ í™•ì¸ í›„ Create userë¥¼ í•´ì£¼ì

> **Secret access keyëŠ” ë‹¨ í•œë²ˆë§Œ ë„ˆì—ê²Œ ë³´ì—¬ì£¼ë‹ˆê¹ access key IDì™€ secret access keyë¥¼ ë³µì‚¬í•´ì•¼ í•œë‹¤.**

ì´ keyë“¤ì€ .envì— ë³µì‚¬í•´ì£¼ê³  herokuì˜ settingsì˜ Config Varsì— ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.

> **ì´ ë¶€ë¶„ì€ AWS ì„¤ì •í•˜ëŠ” ê³¼ì •ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•  ê²½ìš° ì°¸ê³ í•˜ë¼ê³  ì ì–´ë†“ì•˜ë‹¤.**

> **[AccessControlListNotSupported: The bucket does not allow ACLs ì˜¤ë¥˜ í•´ê²°]**
>
> ìœ„ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ëœ¨ì‹œëŠ” ë¶„ë“¤ì€ ë²„í‚·ì— ACLê¶Œí•œì„ ë³€ê²½í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
>
> **ê¶Œí•œ -> ê°ì²´ ì†Œìœ ê¶Œ í¸ì§‘ -> ACL ë¹„í™œì„±í™”ë¨(ê¶Œì¥)ì„ ACL í™œì„±í™”ë¨ë¡œ ë³€ê²½ -> ACLì´ ë³µì›ëœë‹¤ëŠ” ê²ƒì„ í™•ì¸í•©ë‹ˆë‹¤. ì²´í¬ -> ë²„í‚· ì†Œìœ ì ì„ í˜¸ ì²´í¬ -> ë³€ê²½ì‚¬í•­ ì €ì¥**
> ìœ„ì˜ ë°©ë²•ê¹Œì§€ í•´ë³´ì‹œê³ , ê·¸ë˜ë„ ì•ˆ ë˜ì‹œëŠ” ë¶„ë“¤ì€ **ACL(ì•¡ì„¸ìŠ¤ ì œì–´ ëª©ë¡)ì—ì„œ í¸ì§‘->ëª¨ë“  ì‚¬ëŒ(í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤)ì— ë‚˜ì—´, ì½ê¸° ì²´í¬í•´ì£¼ì‹  í›„ ë³€ê²½ì‚¬í•­ ì €ì¥**í•´ì„œ í…ŒìŠ¤íŠ¸í•´ë³´ì‹œë©´ ë  ê±° ê°™ìŠµë‹ˆë‹¤.

> **[No 'Access-Control-Allow-Origin' header is present on the requested resource. ì˜¤ë¥˜ í•´ê²°]**

> ìœ„ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ì½˜ì†”ì°½ì— ëœ¨ì‹œëŠ” ë¶„ë“¤ì€ ê¶Œí•œ -> CORS(Cross-origin ë¦¬ì†ŒìŠ¤ ê³µìœ ) í¸ì§‘ -> ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ì‹œê³  ë³€ê²½ì‚¬í•­ ì €ì¥í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
> https://stackoverflow.com/questions/17533888/s3-access-control-allow-origin-header

```
[
{
"AllowedHeaders": [
"*"
],
"AllowedMethods": [
"GET",
"HEAD"
],
"AllowedOrigins": [
"*"
],
"ExposeHeaders": [],
"MaxAgeSeconds": 3000
}
]
```

> ì¶”ê°€ì ìœ¼ë¡œ ì´ë¯¸ì§€ íƒœê·¸ì™€ ë¹„ë””ì˜¤ íƒœê·¸ì— crossoriginì†ì„±ì„ ì¶”ê°€í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.
> img(src=`ì´ë¯¸ì§€ ì£¼ì†Œ` crossorigin)
> video(src=`ë¹„ë””ì˜¤ ì£¼ì†Œ` crossorigin)

> CORS êµ¬ì„±
> Cross-Origin ìš”ì²­ì„ í—ˆìš©í•˜ë„ë¡ ë²„í‚·ì„ êµ¬ì„±í•˜ë ¤ë©´ CORS êµ¬ì„±ì„ ìƒì„±í•©ë‹ˆë‹¤.
> https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/ManageCorsUsing.html

> AllowedOriginsì„ ì„¤ì •í•˜ëŠ” ì´ìœ 
> í—ˆìš©í•˜ì§€ ì•Šì€ originì—ì„œ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼ ë° ì‚¬ìš©ì„ ë§‰ê¸° ìœ„í•´ì„œì´ë‹¤.
> ë‹¤ì‹œ ë§í•´, í—ˆìš©í•˜ì§€ ì•Šì€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë¦¬ì†ŒìŠ¤ë¥¼ ì£¼ì§€ ì•Šê¸° ìœ„í•¨ì´ê³ , í—ˆìš©í•  ëŒ€ìƒì— ëŒ€í•œ ì„¤ì •ì´ AllowedOriginsì´ë‹¤.

ì´ì œ **Multer S3ë¼ëŠ” íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©**í•  ê²ƒì´ë‹¤.

Multer S3ëŠ” Multerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤€ë‹¤.

    	npm install --save multer-s3
    	npm install aws-sdk

í•­ìƒ multerë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ storageê°€ ë‹¤ë¥´ê¸°ì— ìˆ˜ì •ì„ í•´ì¤˜ì•¼ í•œë‹¤.

í˜„ì¬ middlewareë¥¼ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë˜ì–´ìˆë‹¤.

middleware.js

```js
export const avatarUpload = multer({
  dest: "uploads/avatars",
  limits: {
    fileSize: 3000000,
  },
});

export const videoUpload = multer({
  dest: "uploads/videos",
  limits: {
    fileSize: 10000000,
  },
});
```

ì´ê²ƒì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•´ì£¼ì.

```js
import multerS3 from "multer-s3";
import aws from "aws-sdk";

const s3 = new aws.S3({
  credentials: {
    accessKeyId: process.env.AWS_ID,
    secretAccessKey: process.env.AWS_SECRET,
  },
});

const multerUploader = multerS3({
  s3: s3,
  bucket: "wetube-beom",
});

export const avatarUpload = multer({
  dest: "uploads/avatars",
  limits: {
    fileSize: 3000000,
  },
  storage: multerUploader,
});

export const videoUpload = multer({
  dest: "uploads/videos",
  limits: {
    fileSize: 10000000,
  },
  storage: multerUploader,
});
```

S3 objectë¥¼ ë§Œë“¤ê³  storageë¥¼ ì¤€ ê²ƒì´ë‹¤.

bucketì—ëŠ” ìì‹ ì˜ bucketì´ë¦„ì„ ì ìœ¼ë©´ ë˜ê² ë‹¤.

> herokuì—ë„ ê°™ì€ ë³€ìˆ˜ ì´ë¦„ ì ëŠ”ê²ƒì— ì£¼ì˜í•˜ì.

ì—¬ê¸°ì„œ ë‘ ê°€ì§€ ë¬¸ì œì ì´ ë°œìƒí•˜ëŠ”ë°,

1. ìš°ë¦¬ objectê°€ ê³µê°œë˜ì§€ ì•ŠëŠ”ë‹¤.
2. Access Control Listë¥¼ ì „ë‹¬í•´ì¤˜ì•¼ í•œë‹¤.

1ë²ˆì˜ ê²½ìš° awsì—ì„œ permissionì„ ìˆ˜ì •í•´ì£¼ë©´ ëœë‹¤.

![modify-aws-permission](./screenshot/modify-aws-permission.png)

ë‘ ë²ˆì§¸ì˜ ê²½ìš° ACLì€ ê¸°ë³¸ì ìœ¼ë¡œ objectì˜ ê¶Œí•œì¸ë°, ì´ê²ƒì„ public-readí•´ì¤˜ì•¼ í•œë‹¤.

```js
const multerUploader = multerS3({
  s3: s3,
  bucket: "wetube-beom",
  acl: "public-read",
});
```

ì´ê²ƒë§Œ í•´ì„  ì €ì¥í•  ë•Œ ë§ˆë‹¤ avatarUrlì´ nullì´ ë  ê²ƒì´ë‹¤.

**í˜„ì¬ ì €ì¥í•˜ëŠ” ê³¼ì •ì—ì„œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì€ controller**ì´ê¸° ë•Œë¬¸ì— controllerë¥¼ ê°€ë³´ì.

postEditì„ ê°€ë³´ë©´ í˜„ì¬ fileì´ë¼ëŠ” ë³€ìˆ˜ë¥¼ ë°›ì•„ì„œ ì´ì™€ ê°™ì´ ì²˜ë¦¬í•œë‹¤.

    avatar: file? file.path : avatarUrl,

í•˜ì§€ë§Œ ì—¬ê¸°ì„œ nullê°’ì´ ë“¤ì–´ê°„ë‹¤ëŠ” ê²ƒì€ file.pathê°€ ì—†ë‹¤ëŠ” ê²ƒì´ë‹¤.

> fileì€ ìˆë‹¤. ì™œëƒí•˜ë©´ ì´ì „ avatarUrlë¡œ ëŒ€ì²´ëœê²Œ ì•„ë‹ˆë¼ ì´ë¯¸ì§€ê°€ ì—†ë‹¤ëŠ” nullê°’ì´ ë“¤ì–´ê°”ê¸° ë•Œë¬¸ì´ë‹¤.

![aws-file-location](./screenshot/aws-file-location.png)

pathë¡œ ë“¤ì–´ê°€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ locationìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤.

ê·¸ë˜ì„œ ì´ì™€ ê°™ì´ ë°”ê¿”ì£¼ë©´ ëœë‹¤.

    avatar: file? file.location : avatarUrl,

> videoControllerì—ë„ pathë³€ìˆ˜ ëª…ì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤. ì „ë¶€ ìˆ˜ì •í•´ì£¼ë©´ ëœë‹¤.

ì´ì œ ê²½ë¡œë„ ì˜ ë“¤ì–´ê°€ëŠ” ê²ƒ ê°™ë‹¤.

ì—¬ê¸°ì„œ middlewareë¥¼ ì¢€ë§Œ ë” ìˆ˜ì •í•  ê²ƒì¸ë° **í˜„ì¬ awsë¥¼ í™•ì¸í•´ë³´ë©´ avataríŒŒì¼ê³¼ videoíŒŒì¼ì´ êµ¬ë¶„ì—†ì´ ë“¤ì–´ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.**

ë˜í•œ ë‚´ ì»´í“¨í„°ì—ì„œ ì‘ì—…ì„ í•œë‹¤ë©´ multer s3ì„ ì‚¬ìš©í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.

**ì˜¤ì§ Herokuì—ì„œ ì‘ì—…í•  ë•Œë§Œ multer s3ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.**

ê·¸ë•Œ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ë³€ìˆ˜ê°€ ë‹¤ìŒê³¼ ê°™ë‹¤.

    process.env.NODE_ENV

ì°¸ê³ ë¡œ, í•„ìëŠ” ë¦¬ëˆ…ìŠ¤ë¼ì„œ ê·¸ëŸ°ì§€ NODE_ENVê°€ process.envì— ë‹´ê¸°ì§€ ì•Šê¸° ë•Œë¬¸ì— ì§ì ‘ ì¶”ê°€ í•˜ëŠ” í˜•íƒœë¡œ ì§„í–‰í–ˆë‹¤.

ì½”ë“œëŠ” ì´ì™€ ê°™ì´ ìˆ˜ì •ì´ ë“¤ì–´ê°€ë©´ ëœë‹¤.

middleware.js

```js
const isHeorku = prcess.env.NODE_ENV === "production";

...

const s3ImageUploader = multerS3({
  s3: s3,
  bucket: "wetube-beom/images",
  acl: "public-read",
});

const s3VideoUploader = multerS3({
  s3: s3,
  bucket: "wetube-beom/videos",
  acl: "public-read",
export const avatarUpload = multer({
  dest: "uploads/avatars",
  limits: {
    fileSize: 3000000,
  },
  storage: isHeorku ? s3ImageUploader : undefined,
});

export const videoUpload = multer({
  dest: "uploads/videos",
  limits: {
    fileSize: 10000000,
  },
  storage: isHeorku ? s3VideoUploader : undefined,
});
```

ì•„ê¹Œ ìœ„ì—ì„œ ë³´ì˜€ë˜ multerUploaderëŠ” ì§€ì›Œì¤¬ë‹¤.

ê·¸ê²ƒì„ ì§€ìš°ê³  Video íŒŒì¼ê³¼ AvataríŒŒì¼ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ì„œ ìœ„ì™€ ê°™ì´ í•´ì¤€ ê²ƒì´ë‹¤.

ì´ ë³€ìˆ˜ëŠ” ì—¬ëŸ¬ê°€ì§€ë¡œ í™œìš©ì´ ëœë‹¤.

ìœ„ì—ì„œ controllerë¥¼ ìˆ˜ì •í•  ë•Œ Herokuê°€ ì•„ë‹ˆë©´ file.pathë¥¼ í™œìš©í•´ì•¼ í•œë‹¤. ê·¸ë•Œ ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ë©´ ëœë‹¤.

    avatarUrl: file ? (isHeroku ? file.location : file.path) : avatarUrl,

ë˜í•œ Templateì—ì„œ ìœ„ì—ì„œ ë¬¸ì œìˆì—ˆë˜ Urlë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

ì „ì—­ ë³€ìˆ˜ë¡œ í™œìš©í•˜ê¸° ìœ„í•´ res.localsì— ë„£ì–´ì£¼ì.

middleware.js

```js
  ...
  // In localsMiddleware function
  res.locals.isHeorku = isHeorku
```

templateì—ì„  ë‹¤ìŒê³¼ ê°™ì´ ì£¼ë©´ ë  ê²ƒì´ë‹¤.

header.pug

```pug
...

                li
                    a(href=`/users/${loggedInUser._id}`)
                        if loggedInUser.avatarUrl === ""
                            span ğŸ™‚
                        else
                            if isHeroku
                                img.header__avatar(src=loggedInUser.avatarUrl)
                            else
                                img.header__avatar(src="/" + loggedInUser.avatarUrl)
...

```

í•„ìš”í•œ ë¶€ë¶„ì— ì „ë¶€ ì ìš©í•  ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.

ì´ê²ƒìœ¼ë¡œ í•´ë‹¹ í”„ë¡œì íŠ¸ë¥¼ ì¢…ë£Œê°€ ë˜ì—ˆë‹¤.
