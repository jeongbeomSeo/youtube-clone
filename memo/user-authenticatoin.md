# User Authentication

- [User Authentication](#user-authentication)
  - [1. User Authentication](#1-user-authentication)
  - [2. CRUD](#2-crud)
  - [3. ìœ ì € ìƒì„±](#3-ìœ ì €-ìƒì„±)
    - [3.1 Model ìƒì„±](#31-model-ìƒì„±)
    - [3.2 Template & Controller](#32-template--controller)
    - [3.3 Password Hashing](#33-password-hashing)
      - [3.3.1 Hash Function Feature](#331-hash-function-feature)
      - [3.3.2 bcrypt](#332-bcrypt)
      - [3.3.3 ì ìš©](#333-ì ìš©)
    - [3.4 ê¸°ëŠ¥ ì¶”ê°€](#34-ê¸°ëŠ¥-ì¶”ê°€)
      - [3.4.1 ì¤‘ë³µ ê³„ì •](#341-ì¤‘ë³µ-ê³„ì •)
      - [3.4.2 Template & Controller](#342-template--controller)
      - [3.4.3 $or Operator](#343-or-operator)
      - [3.4.4 Status Code](#344-status-code)
  - [4. ìœ ì € ë¡œê·¸ì¸](#4-ìœ ì €-ë¡œê·¸ì¸)
    - [4.1 Template & Controller](#41-template--controller)
    - [4.2 Session(ì„¸ì…˜)](#42-sessionì„¸ì…˜)
      - [4.2.1 Session vs Cookie](#421-session-vs-cookie)
      - [4.2.2 ì„¸ì…˜ ì²˜ë¦¬ í™˜ê²½ êµ¬ì¶•](#422-ì„¸ì…˜-ì²˜ë¦¬-í™˜ê²½-êµ¬ì¶•)
      - [4.2.3 ì„¸ì…˜ ì²˜ë¦¬](#423-ì„¸ì…˜-ì²˜ë¦¬)
      - [4.2.4 Session connect-mongo](#424-session-connect-mongo)
    - [4.3 .env](#43-env)
      - [4.3.1 í™œìš©ë²•](#431-í™œìš©ë²•)
  - [5. ì†Œì…œ ë¡œê·¸ì¸ êµ¬í˜„](#5-ì†Œì…œ-ë¡œê·¸ì¸-êµ¬í˜„)
    - [5.1 Github ë¡œê·¸ì¸ ë™ì‘ ì›ë¦¬](#51-github-ë¡œê·¸ì¸-ë™ì‘-ì›ë¦¬)
    - [5.2 Githubì— ë“±ë¡í•˜ê¸°.](#52-githubì—-ë“±ë¡í•˜ê¸°)
      - [5.2.1 OAuth Application](#521-oauth-application)
    - [5.3 Githubë¡œ ìœ ì € ì „ì†¡](#53-githubë¡œ-ìœ ì €-ì „ì†¡)
      - [5.3.1 ê°€ë…ì„± ì¢‹ì€ ì½”ë“œë¡œ ìˆ˜ì •](#531-ê°€ë…ì„±-ì¢‹ì€-ì½”ë“œë¡œ-ìˆ˜ì •)
    - [5.4 Access Token](#54-access-token)
      - [5.4.1 Fetch](#541-fetch)
      - [5.4.2 API ì ‘ê·¼](#542-api-ì ‘ê·¼)
  - [6. Log Out](#6-log-out)

## 1. User Authentication

**User Authentication(ì‚¬ìš©ì ì¸ì¦)** ì€ ê¸°ë³¸ì ì¸ ëœ»ì€ ê±°ë˜ ë‹¹ì‚¬ìê°„ì— ìƒëŒ€ì˜ ì‹ ë¶„ì„ ê²€ì¦í•˜ëŠ” ê²ƒì˜ ì˜ë¯¸ë¡œ ì‚¬ìš© ë©ë‹ˆë‹¤. í™ˆí˜ì´ì§€ë¥¼ ì´ìš©í•  ì‚¬ìš©ìë“¤ ì¦‰, Userë“¤ì´ ê³„ì •ì„ ìƒì„±í•  ë•Œ ì„œë²„ì—ì„œ ì •ë³´ë“¤ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í•˜ëŠ”ì§€, ë¡œê·¸ì¸ì„ í•  ë•Œ Userê°€ ë§ëŠ”ì§€, ê¶Œí•œë¶€ì—¬ëŠ” ì–´ë–»ê²Œ í•  ê²ƒì¸ì§€, ì´ëŸ¬í•œ **Userë“¤ì€ ê´€ë¦¬í•˜ëŠ” ë°©ë²•**ë“¤ì„ ì´ íŒŒì¼ì— ì •ë¦¬í•´ ë³¼ ì˜ˆì •ì…ë‹ˆë‹¤.

## 2. CRUD

Videoì™€ ë™ì¼í•˜ê²Œ Userì˜ ê²½ìš°ì—ë„ CRUDê¸°ëŠ¥ì„ ê°–ì¶°ì¤„ í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤. ìœ ì €ë¥¼ ìƒì„±í•˜ëŠ” **Create**, ìœ ì €ì—ê²Œ ê¶Œí•œì„ ì¤˜ì„œ í™ˆí˜ì´ì§€ë¥¼ ì½ê³  ì˜ìƒì„ ì—…ë¡œë“œ í•  ìˆ˜ ìˆëŠ” **Read**, User Profileì„ ìˆ˜ì •í•˜ëŠ” **Update**, ìœ ì € ê³„ì • ì‚­ì œí•˜ëŠ” **Delete**ê°€ ì¡´ì¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ì„  CRUDë¥¼ ì „ë¶€ ë‹¤ë£° ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. ì´ë²ˆ ì±•í„°ì—ì„œ ë‹¤ë£° ê²ƒë“¤ì€ í¬ê²Œ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1.  ìœ ì € ìƒì„±
2.  ìœ ì € ë¡œê·¸ì¸
3.  ì†Œì…œ ë¡œê·¸ì¸(ê¹ƒí—ˆë¸Œ) êµ¬í˜„

## 3. ìœ ì € ìƒì„±

ì§€ê¸ˆê¹Œì§€ ë´ì˜¨ ë°©ì‹ìœ¼ë¡œ ìœ ì € ìƒì„±ì„ ìƒê°í•´ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

1.  ë¨¼ì € ìœ ì € ë°ì´í„° ë² ì´ìŠ¤ê°€ ìƒì„±ë  ìˆ˜ ìˆë„ë¡ Schema ìƒì„± ë° Modelì„ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.
2.  ìœ ì €ê°€ ê³„ì •ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” Pug Page ì¦‰, templateë¥¼ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.
3.  ìœ ì €ì—ê²Œ ì •ë³´ë¥¼ ë„˜ê²¨ ë°›ìœ¼ë©´ Modelì„ ì´ìš©í•´ì„œ ë°ì´í„° ë² ì´ìŠ¤ì— ì €ì¥ì„ í•´ì¤ë‹ˆë‹¤.

ìƒê°ë³´ë‹¤ ê°„ë‹¨í•´ ë³´ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ, ë§Œì•½ ìœ ì €ì—ê²Œ ë°›ì€ ëª¨ë“  ì •ë³´ë¥¼ ë°ì´í„° ë² ì´ìŠ¤ì— ê·¸ëŒ€ë¡œ ë„£ëŠ”ë‹¤ê³  í•˜ë©´ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤. ì‚¬ëŒë“¤ì€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•  ë•Œ ì‚¬ì´íŠ¸ë³„ë¡œ ë‹¤ ë‹¤ë¥´ê²Œ í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ë¹„ìŠ·í•˜ê±°ë‚˜ ë™ì¼í•˜ê²Œ ì‚¬ìš©í•©ë‹ˆë‹¤.**ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ê·¸ëŒ€ë¡œ ë„£ì–´ì¤¬ì„ ë•Œ í•´í‚¹ì„ ë‹¹í•œë‹¤ë©´ ë‹¤ë¥¸ ì‚¬ì´íŠ¸ì—ê²Œë„ í”¼í•´ê°€ ê°ˆ ê²ƒì…ë‹ˆë‹¤.** ì´ëŸ¬í•œ ë¬¸ì œì ì„ í•´ê²°í•´ ê°€ë©´ì„œ ì§„í–‰ì„ í•´ë´…ì‹œë‹¤.

### 3.1 Model ìƒì„±

ë¨¼ì € Userì˜ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œ **models í´ë”**ì•ˆì— **User.js**ë¥¼ ìƒì„±í•´ ì£¼ì.

models/User.js

```js
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  name: { type: String, required: true },
  location: String,
});

const User = mongoose.model("User", userSchema);
// ì—¬ê¸°ì„œ modelì„ Modelë¡œ ì•ˆì“°ê²Œ ì£¼ì˜í•˜ì. ì˜¤ë¥˜ê°€ ë‚  ê²ƒì…ë‹ˆë‹¤.
export default User;
```

ì½”ë“œ ë¶„ì„ì„ ì¢€ í•´ë³´ìë©´, **emailì´ë‚˜ usernameì˜ ê²½ìš° ì¤‘ë³µë˜ë©´ ê³„ì • ìƒì„±**í•˜ëŠ”ë° ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤. ì´ ë‘˜ì€ ì¤‘ë³µë˜ë©´ ì•ˆë  ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ **unique: true**ë¥¼ ì¤Œìœ¼ë¡œì¨ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¤‘ë³µ ëœ ê²ƒì€ ë°›ì§€ ì•Šë„ë¡ í•´ë†“ì•˜ìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ëŠ” ì´ì „ ë‚´ìš©ê³¼ ë™ì¼í•¨ìœ¼ë¡œ ìŠ¤í‚µí•˜ê² ìŠµë‹ˆë‹¤. ì´í›„ Templateì™€ controllerë¥¼ ë§Œë“¤ì–´ ì£¼ë©´ ë©ë‹ˆë‹¤.

### 3.2 Template & Controller

TemplateëŠ” Home Pageì—ì„œ join.pugë¡œ ì´ë™í•  ìˆ˜ ìˆëŠ” anchorë¥¼ êµ¬í˜„í•´ ë†“ê³  join.pugë¥¼ ë§Œë“¤ë©´ ë  ê²ƒì…ë‹ˆë‹¤. join.pugë§Œ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

join.pug

```pug
extends base

block content
  form(method="post")
    input(placeholder="Name" name="name" , type="text", required )
    input(placeholder="Eamil" name="email" , type="email", required )
    input(placeholder="Username" name="username" , type="text", required )
    input(placeholder="Password" name="password" , type="password", required )
    input(placeholder="Location" name="location" , type="text", required )
    input(type="submit", value="Join")

  hr
  div
    span Already have an account?
    a(href="/login")  Log in now &rarr;
```

ì´ì œ ìœ ì €ê°€ ì„œë²„ì— ì •ë³´ë¥¼ ì „ì†¡í•˜ë©´ ì„œë²„ì—ì„  controllerë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ í•„ìš”í•œëŒ€ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°ì´í„° ë² ì´ìŠ¤ì— ë„£ì–´ì£¼ë©´ ë˜ê² ìŠµë‹ˆë‹¤.

usercontroller.js

```js
export const postJoin = async (req, res) => {
  const { name, username, email, password, location } = req.body;
  await User.create({
    name,
    username,
    email,
    password,
    location,
  });
  return res.rediret("/login");
};
```

ì´ê²ƒì„ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•œë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë°ì´í„° ë² ì´ìŠ¤ì— ë‹´ê²¨ì ¸ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

![exposure password problem](./screenshot/exposure-password.png)

[ìœ„ì—ì„œ](#3-ìœ ì €-ìƒì„±) ë§í–ˆë‹¤ì‹¶íˆ Passwordë¥¼ ê·¸ëŒ€ë¡œ ë„£ì–´ì¤„ ê²½ìš° ë³´ì•ˆìƒ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ **Hashing(í•´ì‹±)** ì´ë¼ëŠ” ê°œë…ì´ ë‚˜ì˜µë‹ˆë‹¤.

### 3.3 Password Hashing

ê°œì¸ì •ë³´ë¥¼ ìˆ¨ê¸°ê¸° ìœ„í•´ ì•”í˜¸í™” ê³¼ì •ì´ í•„ìš”í•œ ê²ƒì€ ì´í•´í–ˆìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì•”í˜¸í™”ë¥¼ í•´ì•¼í•˜ëŠ” ê²ƒì¼ê¹Œìš”? ìš°ë¦¬ê°€ í‰ì†Œì— ë§ì´ ë´ì™”ë˜ **ì•”í˜¸í™”(Encryption)** ëŠ” **Hahsing**ê³¼ëŠ” ë‹¤ë¥¸ ê°œë…ì…ë‹ˆë‹¤. ê°€ì¥ í° ì°¨ì´ëŠ” **'ë°©í–¥ì„±'** ì…ë‹ˆë‹¤. **Encryption**ì€ **ì–‘ë°©í–¥**ì´ì§€ë§Œ, **Hashing**ì˜ ê²½ìš° **ë‹¨ë°©í–¥**ì…ë‹ˆë‹¤. ê°„ë‹¨í•˜ê²Œ ë§í•˜ìë©´, **_Encrpytionì€ ê²°ê³¼ê°’ìœ¼ë¡œ ë¶€í„° ì…ë ¥ê°’ì„ ì•Œ ìˆ˜ ìˆì§€ë§Œ, Hashingì˜ ê²½ìš° ì•Œ ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ì—†ìŠµë‹ˆë‹¤._**

**ì˜ˆë¥¼ ë“¤ì–´,** hashingì˜ ê²½ìš° 121212 ë¥¼ ì…ë ¥í–ˆì„ ë•Œ -> c4f76645 ì´ëŸ°ì‹ìœ¼ë¡œ hashingì„ í•©ë‹ˆë‹¤. ì´ê²ƒì€ ì…ë ¥ê°’ì—ì„œì˜ ì¶œë ¥ê°’ì€ ê³ ì •ë˜ì–´ ìˆì§€ë§Œ, ì¶œë ¥ê°’ì—ì„œ ê²°ê³¼ê°’ì„ ì•Œ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ëŠ” ê²ƒì…ë‹ˆë‹¤. [í•´ë‹¹ ì‚¬ì´íŠ¸](https://emn178.github.io/online-tools/index.html)ë¥¼ ì°¸ê³ í•˜ë©´ ë©ë‹ˆë‹¤.

#### 3.3.1 Hash Function Feature

**í•´ì‹œí•¨ìˆ˜ì˜ íŠ¹ì§•**ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1.  **ì–´ë–¤ ì…ë ¥ ê°’ì—ë„ í•­ìƒ ê³ ì •ëœ ê¸¸ì´ì˜ í•´ì‹œ ê°’ì„ ì¶œë ¥í•©ë‹ˆë‹¤.**
2.  **ì…ë ¥ ê°’ì˜ ì•„ì£¼ ì¼ë¶€ë§Œ ë³€ê²½ë˜ì–´ë„ ì „í˜€ ë‹¤ë¥¸ ê²°ê³¼ ê°’ì„ ì¶œë ¥í•©ë‹ˆë‹¤.(ëˆˆì‚¬íƒœ íš¨ê³¼)**
3.  **ì¶œë ¥ëœ ê²°ê³¼ ê°’ì„ í† ëŒ€ë¡œ ì…ë ¥ ê°’ì„ ìœ ì¸„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**
4.  **ì…ë ¥ ê°’ì€ í•­ìƒ ë™ì¼í•œ í•´ì‹œ ê°’ì„ ì¶œë ¥í•©ë‹ˆë‹¤.**

> í”íˆ ì•Œê³ ìˆëŠ” **ë¹„íŠ¸ì½”ì¸**ì—ì„œëŠ” **SHA-256 ë°©ì‹ì˜ í•´ì‹œ í•¨ìˆ˜**ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ìœ„ì™€ ê°™ì´ í•´ì‹œ í•¨ìˆ˜ëŠ” ì…ë ¥ ê°’ì´ ë™ì¼í•˜ë©´ ì‹œê°„ê³¼ ìƒê´€ ì—†ì´ ë™ì¼í•œ í•´ì‹œ ê°’ì„ ì¶œë ¥í•©ë‹ˆë‹¤. ì´ê²ƒì„ **deterministic function(ê²°ì •ì  í•¨ìˆ˜)** ì´ë¼ê³  í•©ë‹ˆë‹¤.

> **ê²°ì •ì  í•¨ìˆ˜**ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ ìƒíƒœê°€ ê°™ì„ ê²½ìš° íŠ¹ì • ì…ë ¥ ê°’ ì§‘í•©ìœ¼ë¡œ í˜¸ì¶œë  ë•Œë§ˆë‹¤ í•­ìƒ ë™ì¼í•œ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

> **ë¹„ê²°ì •ì  í•¨ìˆ˜**ëŠ” ì•¡ì„¸ìŠ¤í•˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì˜ ìƒíƒœê°€ ë™ì¼í•˜ê²Œ ìœ ì§€ë˜ë”ë¼ë„ íŠ¹ì • ì…ë ¥ ê°’ ì§‘í•©ìœ¼ë¡œ í˜¸ì¶œë  ë•Œë§ˆë‹¤ ë‹¤ë¥¸ ê²°ê³¼ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë ‡ë‹¤ë©´ **í•´ì‹œ í•¨ìˆ˜**ë¥¼ ì‚¬ìš©í•˜ë©´ ë³´ì•ˆì´ ì² ì²˜í•˜ê²Œ ì´ë£¨ì–´ ì§€ëŠ” ê²ƒì¸ê°€?

ê¼­ ê·¸ë ‡ì§€ë§Œì€ ì•ŠìŠµë‹ˆë‹¤.

**Rainbow Table**ì€ í•´ì‹œ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€í™˜ ê°€ëŠ¥í•œ ëª¨ë“  í•´ì‹œ ê°’ì„ ì €ì¥ì‹œì¼œ ë†“ì€ í‘œì…ë‹ˆë‹¤. ì´ê²ƒì„ ì´ìš©í•˜ì—¬ ê³µê²©í•˜ëŠ” ë°©ì‹ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë¯¸ë¦¬ ê°€ëŠ¥í•œ íŒ¨ìŠ¤ì›Œë“œ ì¡°í•©ì„ ë‹¤ ê³„ì‚°í•œ í…Œì´ë¸”ì„ ê°€ì§€ê³  ë¹„êµë§Œ ìˆ˜í–‰í•˜ë©° ê³µê²©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ê²ƒì´ **ì‚¬ì „ ê³µê²©**ì¸ë°, ì´ **dictionary**ë¥¼ í•´ì‹œê°’ ê²€ìƒ‰ì— ìµœì í™”ì‹œí‚¨ ê²ƒì„ **Rainbow Table**ì´ë¼ê³  í•˜ëŠ”ê²ƒì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ê²ƒë“¤ ë•Œë¬¸ì— **"Salt"** ë¼ëŠ” ê°œë…ì´ ì¶”ê°€ëœ **bcrypt**ë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤.

#### 3.3.2 bcrypt

**bcrypt**ëŠ” NodeJSì—ì„œ ì‚¬ìš©ë˜ëŠ” **Hash Functionì„ ì‚¬ìš©í•œ íŒ¨ìŠ¤ì›Œë“œ ì•”í˜¸í™” íŒ¨í‚¤ì§€(ë¼ì´ë¸ŒëŸ¬ë¦¬)**ì…ë‹ˆë‹¤. Blowfish ì•”í˜¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ê³„ëœ **ì•”í˜¸í™” í•¨ìˆ˜**ì´ë©° í˜„ì¬ê¹Œì§€ ì‚¬ìš©ì¤‘ì¸ **ê°€ì¥ ê°•ë ¥í•œ í•´ì‹œ ë©”ì»¤ë‹ˆì¦˜ ì¤‘ í•˜ë‚˜**ì…ë‹ˆë‹¤.ìœ„ì—ì„œ ë§í–ˆë‹¤ì‹¶íˆ **bcrypt**ëŠ” Rainbow Tableì„ ì´ìš©í•œ ê³µê²©ì„ ì‚¬ì „ì— ë°©ì§€í•˜ê¸° ìœ„í•´ **Salt**ë¼ëŠ” ê°œë…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.

**Salting**ì€ ìŒì‹ì— ê°„ì„ ì¹˜ë“¯ì´, ìœ ì €ê°€ ì–´ë–¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í–ˆë“ ì§€ ìƒê´€ì—†ì´, ê±°ê¸°ì— ë‚œìˆ˜ê¹Œì§€ ì¶”ê°€í•˜ì—¬ í•´ì‹œí•¨ìˆ˜ì— ì§‘ì–´ë„£ëŠ” ê²ƒì…ë‹ˆë‹¤. ì¦‰,
ë¹„ë°€ë²ˆí˜¸ì˜ ë³µì¡ë„ë¥¼ í‚¤ì›Œ ë³´ì•ˆì„ ë†’ì´ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

    bcrypt.hash(myPlaintextPassword, saltRounds, function(){ });

ì—¬ê¸°ì„œ **SaltRounds Argument**ì˜ ì‚¬ìš©ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

**ì˜ˆë¥¼ ë“¤ì–´, SaltRounds**ê°€ **2**ë¼ê³  í•œë‹¤ë©´ **_123456 -> 9f0b9sdfuxc7 -> h2fassd452sd_** ì´ëŸ°ì‹ìœ¼ë¡œ **Hashingì„ ë‘ë²ˆ ê±°ì¹˜ëŠ” ê²ƒì…ë‹ˆë‹¤.** SaltRoundsì— ì…ë ¥í•œ ìˆ«ìë§Œí¼ Hashingì„ í•´ì£¼ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì´ì œ í”„ë¡œì íŠ¸ì— ì ìš©í•´ ê°€ë©° ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ì§€ ìµí˜€ë´…ì‹œë‹¤.

#### 3.3.3 ì ìš©

ë¹„ë°€ë²ˆí˜¸ë¥¼ í•´ì‹±í•˜ëŠ” ê²ƒì€ ìœ ì €ë¥¼ ìƒì„±(ì €ì¥)í•˜ê¸° ì „ì— ì‹¤í–‰ë˜ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê·¸ë ‡ë‹¤ë©´ ì´ì „ì— ë°°ì› ë˜ ê²ƒì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°”ë¡œ **pre("save", function {})** ì…ë‹ˆë‹¤. User.js ì— ë‹¤ìŒê³¼ ê°™ì´ í•˜ë©´ ë©ë‹ˆë‹¤.

models/User.js

```js
userSchema.pre("save", async function () {
  console.log("Users password:", this.password);
  this.password = await bcrypt.hash(this.password, 5);
  console.log("Hahsed password:", this.password);
});
```

ì´ì œ **SaltRounds**ê°€ 5ì¸ Hash Functionì„ ì ìš©ì‹œì¼°ìŠµë‹ˆë‹¤. ì¶œë ¥ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![Hash Function](./screenshot/Hash-Function.png)

ì´ë ‡ê²Œ í•´ì„œ ìœ ì € ìƒì„±ì„ í•˜ëŠ” ê²ƒì€ ì–¼ì¶” ë§ˆë¬´ë¦¬ê°€ ëœ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì´ì œ ì²˜ë¦¬í•´ì•¼ ë  ê²ƒì€ **ìœ ì €ë¥¼ ìƒì„±í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œì **ë“¤ì„ í•˜ë‚˜ì”© ê³ ì³ë‚˜ê°€ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

### 3.4 ê¸°ëŠ¥ ì¶”ê°€

ì´ì œ ìœ ì €ë¥¼ ìƒì„±í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œì ë“¤ì„ ê³ ì¹˜ê¸° ìœ„í•´ í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.

#### 3.4.1 ì¤‘ë³µ ê³„ì •

í˜„ì¬ Modelì„ ë‹¤ì‹œ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

models/User.js

```js
import mongoose from "mongoose";

const userSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  name: { type: String, required: true },
  location: String,
});
```

**requiredì™€ uniqueë¥¼ ì¤€ í•„ë“œ**ì— **ë°ì´í„°ë² ì´ìŠ¤ì— ì¶”ê°€ë˜ì–´ ìˆëŠ” ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ì„œë²„ì—ì„œ ì˜¤ë¥˜**ê°€ ë‚˜ì˜¬ ê²ƒì¸ë° **ìœ ì € ë˜í•œ ì—ëŸ¬ë¥¼ ì•Œ ìˆ˜ ìˆë„ë¡** í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤. í˜„ì¬ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì„ ë•Œ ìƒí™© ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šì•„ ë‹¨ìˆœíˆ ì˜¤ë¥˜ë§Œ ë„ì–´ì¤„ ë¿ì…ë‹ˆë‹¤.

    MongoError: E11000 duplicate key error collection

ì–´ë–»ê²Œ í•˜ë©´ ë ê¹Œìš”? templateì— errorMessageë¥¼ ë°›ì•˜ì„ ë•Œ ë„ìš¸ ìˆ˜ ìˆë„ë¡ í•´ë†“ê³  controllerì—ì„œ ì²˜ë¦¬í•´ì„œ ë³´ë‚´ì£¼ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

#### 3.4.2 Template & Controller

join.pugì™€ userController.jsëŠ” ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

join.pug

```pug
extends base

block content
	if errorMessage
		span=errorMessage
  form(method="post")
    input(placeholder="Name" name="name" , type="text", required )
    input(placeholder="Eamil" name="email" , type="email", required )
    input(placeholder="Username" name="username" , type="text", required )
    input(placeholder="Password" name="password" , type="password", required )
    input(placeholder="Confirm Password" name="password2" , type="password", required )
    input(placeholder="Location" name="location" , type="text", required )
    input(type="submit", value="Join")
```

userController.js

```js
export const postJoin = async (req, res) => {
  const { name, username, email, password, location } = req.body;
  const pageTitle = "Join";
  if (password !== password2) {
    return res.render("join", {
      pageTitle,
      errorMessage: "Password confirmation dose not match.",
    });
  }
  const usernameExists = await User.exists({ username });
  if (usernameExists) {
    return res.render("join", {
      pageTitle,
      errorMessage: "This username is already taken.",
    });
  }
  const emailExists = await User.exists({ email });
  if (emailExists) {
    return res.render("join", {
      pageTitle,
      errorMessage: "This email is already taken.",
    });
  }

  await User.create({
    name,
    username,
    email,
    password,
    location,
  });
  return res.redirect("/login");
};
```

ì´ì „ ì±•í„°ì—ì„œ ë°°ì› ë˜ **exists()** í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ controllerì—ì„œ ì²˜ë¦¬í•œ ì½”ë“œì…ë‹ˆë‹¤. í•˜ì§€ë§Œ **userName**ì˜ ì½”ë“œì™€ **email**ì˜ ì½”ë“œê°€ ìœ ì‚¬í•œ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ´ ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ê²ƒì´ **$or Operator**ì…ë‹ˆë‹¤.

#### 3.4.3 $or Operator

ë¨¼ì € **$orì—°ì‚°ì**ë¥¼ ì•Œì•„ë³´ê¸° ì „ì— **ì¿¼ë¦¬ ì—°ì‚°ì**ê°€ ë¬´ì—‡ì¸ì§€ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. **ì¿¼ë¦¬ ì—°ì‚°ì**ì—ëŠ” **ë¹„êµ ì¿¼ë¦¬**ì™€ **ë…¼ë¦¬ ì¿¼ë¦¬**ë¡œ ë‚˜ëˆ ì ¸ ìˆê³ , ì¢…ë¥˜ë³„ë¡œ ê°ê¸° ë‹¤ë¥¸ ê¸°ëŠ¥ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì¢…ë¥˜ê°€ ë§ìœ¼ë¯€ë¡œ ë§í¬ë§Œ ë‹¬ì•„ ë†“ê² ìŠµë‹ˆë‹¤. [(MongoDB) ë¹„êµ,ë…¼ë¦¬ ì¿¼ë¦¬ ì—°ì‚°ì - ZeroCho Blog](https://www.zerocho.com/category/MongoDB/post/57a17d114105f0a03bc55f74)

> SQL ì¿¼ë¦¬ ëª¨ìŠµ: SELECT \* FROM table WHERE column="value"

> MongoDB ì¿¼ë¦¬ ëª¨ìŠµ: collection.find({"field": "value}, {})

ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

    const exists = await User.exists({ $or: [{ username }, { email }] });

ì´ë ‡ê²Œ í•˜ë©´ usernameì´ë‚˜ email ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ User databaseì•ˆì— ìˆì„ ë•Œ Trueê°’ì„ ë°˜í™˜í•´ ì¤ë‹ˆë‹¤.

ë§Œì•½ ë‹¤ìŒê³¼ ê°™ì´ í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œìš”?

    const usernameExists = await User.exists({ username, email });

usernameê³¼ emailì´ **ë™ì‹œì— ì¼ì¹˜í•  ë•Œë§Œ** Trueê°’ì„ ë°˜í™˜í•´ ì¤„ ê²ƒì…ë‹ˆë‹¤.

ë‹¤ë§Œ, **$or Operator**ì„ ì¼ì„ ë•Œ ë‹¨ì ì€ ìœ ì €ì—ê²Œ usernameì´ ì¤‘ë³µë˜ì„œ ì˜¤ë¥˜ê°€ ë‚œê±´ì§€, emailì´ ì¤‘ë³µë˜ì„œ ì˜¤ë¥˜ê°€ ë‚œê±´ì§€ ì•Œë ¤ì¤„ ìˆ˜ ì—†ê³  ë‹¨ì§€ username í˜¹ì€ emailì´ ì¤‘ë³µë˜ì—ˆë‹¤ëŠ” Messageë¥¼ ì „ë‹¬ í•  ìˆ˜ ë°–ì— ì—†ëŠ”ê²ƒì…ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ ë§ì´ì£ .

```js
  if (exists) {
    return rex.render("join", {
      pageTitle,
      errorMessage: "This username/email is already taken.",
    });
```

ì´ ë¶€ë¶„ì€ ì–´ì©” ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ ìƒíƒœë¡œ ëƒ…ë‘ê³  ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°€ ë´…ì‹œë‹¤.

#### 3.4.4 Status Code

ë§Œì•½ êµ¬ê¸€ í¬ë¡¬ì—ì„œ ê³„ì •ì„ ìƒì„±í•˜ëŠ”ë° usernameì´ë‚˜ emailì´ ì¤‘ë³µë˜ì–´ì„œ Pageì—ì„œ errorMessageë¥¼ ë°›ëŠ”ë‹¤ê³  í•´ë´…ì‹œë‹¤. **ê·¸ëŸ°ë° í¬ë¡¬ì—ì„  ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì €ì¥í•˜ê² ëƒê³  ë¬¼ì–´ë´…ë‹ˆë‹¤.** ì´ê²ƒì€ ì´ìƒí•˜ë‹¤. ë¶„ëª… errorMessageë„ ë°›ê³  ì¤‘ë³µë˜ëŠ” ê²ƒì¸ë° ì´ëŸ°ê²ƒì„ ë¬¼ì–´ë³¸ë‹¤ëŠ” ê²ƒì€ ë¸Œë¼ìš°ì €ì—ì„  ë¬¸ì œê°€ ìˆë‹¤ê³  íŒë‹¨í•˜ì§€ ì•Šì€ ê²ƒì…ë‹ˆë‹¤.

Loggerì— ì°íˆëŠ” Status Codeë¥¼ ë³´ë‹ˆ 200ì´ ì°í˜€ ìˆì—ˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ë¸Œë¼ìš°ì €ê°€ ë¬¸ì œ ì—†ì´ ëŒì•„ ê°„ë‹¤ ì¦‰, OKë¼ê³  ë§í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

[ìœ„í‚¤ë°±ê³¼ HTTP ìƒíƒœì½”ë“œ](https://ko.wikipedia.org/wiki/HTTP_%EC%83%81%ED%83%9C_%EC%BD%94%EB%93%9C)

ì½”ë“œë¥¼ ìˆ˜ì •í•  í•„ìš”ê°€ ìˆì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ì²˜ë¦¬í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

controller.js

```js
...

if (exists) {
return res.status(400).render("join", {
pageTitle,
errorMessage: "This username/email is already taken.",
});
}

...
```

Status Codeë¥¼ ë³´ë‚´ëŠ” ê²ƒì´ ê·¸ë ‡ê²Œ ì¤‘ìš”í•˜ì§€ ì•Šê²Œ ë³´ì¼ ìˆ˜ ìˆì§€ë§Œ ê·¸ë ‡ì§€ ì•ŠìŠµë‹ˆë‹¤.

ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë°©ë¬¸í•œ ì›¹ì‚¬ì´íŠ¸ì˜ íˆìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•˜ëŠ”ë°, ë§Œì•½ ë¬¸ì œê°€ ìˆëŠ” ì›¹ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í–ˆê³  status code 200ì„ ë°›ëŠ”ë‹¤ë©´ ê·¸ëŒ€ë¡œ íˆìŠ¤í† ë¦¬ì— ì €ì¥ì„ í•  ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ, status code 400ì„ ë°›ëŠ”ë‹¤ë©´ íˆìŠ¤í† ë¦¬ì— ë‚¨ê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤.
**ì´ê²ƒì´ ë¸Œë¼ìš°ì €ì—ê²Œ ìœ ì¼í•˜ê²Œ ì•Œë ¤ì£¼ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.**

ìµœì¢…ì ìœ¼ë¡œ **try-catchë¬¸**ê¹Œì§€ ì²˜ë¦¬ë¥¼ í•˜ê³  ë‚˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ **postJoin**ì´ ë§ˆë¬´ë¦¬ë©ë‹ˆë‹¤.

```js
export const postJoin = async (req, res) => {
  const { name, username, email, password, password2, location } = req.body;
  const pageTitle = "Join";
  const exists = await User.exists({ $or: [{ username }, { email }] });

  if (password !== password2) {
    return rex.status(400).render("join", {
      pageTitle,
      errorMessage: "Password confirmation dose not match.",
    });
  }

  if (exists) {
    return rex.status(400).render("join", {
      pageTitle,
      errorMessage: "This username/email is already taken.",
    });
  }
  try {
    await User.create({
      name,
      username,
      email,
      password,
      location,
    });
    return res.redirect("/login");
  } catch (error) {
    return res.status(400).render("join", {
      pageTitle: pageTitle,
      errorMessage: error._message,
    });
  }
};
```

ì´ë ‡ê²Œ í•´ì„œ ê³„ì • ìƒì„± í˜ì´ì§€ëŠ” ì™„ë£Œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.

## 4. ìœ ì € ë¡œê·¸ì¸

ì´ ë¶€ë¶„ì—ì„œ ì‹ ê²½ì¨ì¤˜ì•¼ í•  ê²ƒì„ ìƒê°í•´ë³´ë‹ˆ ë‹¤ìŒê³¼ ê°™ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ìš°ë¦¬ê°€ í‰ì†Œì— ì›¹ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•´ì„œ ë¡œê·¸ì¸ì„ í•˜ë©´ **í•´ë‹¹ ì›¹ì‚¬ì´íŠ¸ë‚´ì—ì„œ ì›€ì§ì—¬ë„ ë¡œê·¸ì¸ì´ ìœ ì§€**ê°€ ë˜ì–´ ìˆëŠ”ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë˜í•œ, í˜ì´ì§€ë¥¼ ë‹«ì•˜ë‹¤ê°€ ë¹ ë¥´ê²Œ ë‹¤ì‹œ ë“¤ì–´ê°€ë©´ ë¡œê·¸ì¸ì´ ë˜ì–´ ìˆëŠ” ê²½ìš°ë„ ì¢…ì¢… ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë˜í•œ, ê³„ì •ì„ ìƒì„±í•  ë•Œ **Hashing**ê³¼ì •ì„ ê±°ì³¤ëŠ”ë°, ë¡œê·¸ì¸í•  ë•Œ ë°ì´í„° ë² ì´ìŠ¤ì— ìˆëŠ” ì •ë³´ë‘ ë¹„êµí•  ë•Œ ì‹ ê²½ ì¨ì¤˜ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

ì´ ë¶€ë¶„ë“¤ì„ ìƒê°í•´ ê°€ë©´ì„œ ì§„í–‰í•´ ê°€ë©´ ë˜ê² ìŠµë‹ˆë‹¤.

### 4.1 Template & Controller

Login Pageì˜ ê²½ìš° Join Pageì™€ ìœ ì‚¬í•  ê²ƒì…ë‹ˆë‹¤.

login.pug

```pug
extends base

block content
  form(method="post")
    input(placeholder="Username" name="username" , type="text", required )
    input(placeholder="Password" name="password1" , type="password", required )
    input(type="submit", value="Join")

  hr
  div
    span Don't have an account?
    a(href="/join") Create one now &rarr;
```

ì´ ë‚´ìš©ë“¤ì„ ë°›ê³  ë°ì´í„° ë² ì´ìŠ¤ì— usernameì´ ì¼ì¹˜í•˜ëŠ” ê²ƒì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê³¼ì •ê¹Œì§€ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

userController.js

```js
export const postLogin = async (req, res) => {
  const { username, password } = req.body;
  const exists = await User.exists({ username });
  if (!exists) {
    return res.status(400).render("login", {
      pageTitle: "Login",
      errorMessage: "An account with this username dose not exists.",
    });
  }
  // check if password correct
  return res.end();
};
```

ì´ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¹„êµí•´ ë³¼ ê²ƒì¸ë°, ìœ„ì—ì„œ ë§í–ˆë‹¤ì‹¶íˆ ì´ì „ì— ë¹„ë°€ë²ˆí˜¸ëŠ” [í•´ì‹± ì²˜ë¦¬](#333-ì ìš©)ë¥¼ í–ˆìŠµë‹ˆë‹¤.

**Hash Function**ì˜ íŠ¹ì§•ìƒ **ì…ë ¥ê°’ì´ ë™ì¼**í•˜ë‹¤ë©´ ì‹œê°„ì— êµ¬ì• ë°›ì§€ ì•Šê³  **ë™ì¼í•œ ê²°ê³¼ê°’ì„ ì¶œë ¥**í•œë‹¤ê³  ë§í–ˆìŠµë‹ˆë‹¤.

ê·¸ë ‡ê²Œí•´ì„œ ë¹„êµí•˜ëŠ” ê²ƒì´ **bcrypt.compare**ì…ë‹ˆë‹¤.

ì‚¬ìš©ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

    bcrypt.compare(myPlaintextPassword, hash)

controllerì— ì§ì ‘ ì ìš©í•´ì„œ í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ í•´ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

controller.js

```js
export const postLogin = async (req, res) => {
  const { username, password } = req.body;
  const pageTitle = "Login";
  const user = await User.findOne({ username });
  if (!user) {
    return res.status(400).render("login", {
      pageTitle,
      errorMessage: "An account with this username dose not exists.",
    });
  }
  const ok = await bcrypt.compare(password, user.password);
  if (!ok) {
    return res.status(400).render("login", {
      pageTitle,
      errorMessage: "Wrong Password",
    });
  }
  console.log("Log User IN! Coming Soon!");
  return res.redirect("/");
};
```

> ì—¬ê¸°ì„œ ìƒê¸°ëŠ” ê¶ê¸ˆì¦ì´ ìˆë‹¤.
>
> í˜„ì¬ [ìœ„ì—ì„œ](#333-ì ìš©) ë³´ë©´ **Hashing**ì„ í•˜ëŠ” ê³¼ì •ì—ì„œ **Salting**ì„ í•´ì¤¬ëŠ”ë° ê·¸ê²ƒì€ ì‹ ê²½ ì“°ì§€ ì•Šê³  compare í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ë˜ëŠ”ê²ƒì¸ê°€?
>
> > Hashê°’ì„ ë“¤ì—¬ë‹¤ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë˜ì–´ ìˆë‹¤.
> > ![Hash](./screenshot/Hash.png)
> > ì°¸ê³ : [bcrypt - ìœ„í‚¤ë°±ê³¼, ìš°ë¦¬ ëª¨ë‘ì˜ ë°±ê³¼ì‚¬ì „](https://ko.wikipedia.org/wiki/Bcrypt)

ì—¬ê¸°ê¹Œì§€ í•œ ê²ƒìœ¼ë¡  ì•„ì§ ì›¹ì‚¬ì´íŠ¸ë‚´ì˜ ëª¨ë“  í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸ì„ ìœ ì§€í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê·¸ê²ƒì€ **Session**ì„ ì•Œì•„ë³´ë©´ì„œ êµ¬í˜„í•˜ë„ë¡ í•´ë´…ì‹œë‹¤.

### 4.2 Session(ì„¸ì…˜)

ì„¸ì…˜ì€ ê°„ë‹¨í•˜ê²Œ ë§í•˜ìë©´, ë°±ì—”ë“œì™€ ë¸Œë¼ìš°ì € ê°„ì— ì–´ë–¤ í™œë™ì„ í–ˆëŠ”ì§€ ê¸°ì–µí•˜ëŠ” ê²ƒì„ ë§í•©ë‹ˆë‹¤. í‰ì†Œì— ìš°ë¦¬ëŠ” ì¿ í‚¤ë¼ëŠ” ë‹¨ì–´ëŠ” ë§ì´ ë“¤ì–´ ë´¤ì„ ê²ƒì…ë‹ˆë‹¤. ì¿ í‚¤ë‘ ì„¸ì…˜. ì–´ë–¤ ì°¨ì´ë¥¼ ê°€ì§€ê³  ìˆê³  ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€ ì•Œì•„ë´…ì‹œë‹¤.

#### 4.2.1 Session vs Cookie

ë¨¼ì € **Cookieì˜ ê°œë…**ì„ ì‚´í´ë´…ì‹œë‹¤.

**ì¿ í‚¤(Cookie)** ë€ **í•˜ì´í¼ í…ìŠ¤íŠ¸ì˜ ê¸°ë¡ì„œ(HTTP)** ì˜ ì¼ì¢…ìœ¼ë¡œì„œ ì¸í„°ë„· ì‚¬ìš©ìê°€ ì–´ë– í•œ ì›¹ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•  ê²½ìš° ê·¸ ì‚¬ì´íŠ¸ê°€ ì‚¬ìš©í•˜ê³  ìˆëŠ” ì„œë²„ë¥¼ í†µí•´ ì¸í„°ë„· ì‚¬ìš©ìì˜ ì»´í“¨í„°ì— ì„¤ì¹˜ë˜ëŠ” ì‘ì€ ê¸°ë¡ ì •ë³´ íŒŒì¼ì„ ì¼ì»«ëŠ”ë‹¤.

**ì¿ í‚¤ ì¢…ë¥˜**ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

- ê¸°ìˆ ì  ì¿ í‚¤: ê²€ìƒ‰í•˜ëŠ” ì£¼ì²´ê°€ ì‚¬ëŒì¸ì§€ ì•„ë‹ˆë©´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì¸ì§€ ì´ìš©ì êµ¬ë¶„ ê¸°ëŠ¥ ìˆ˜í–‰

- ë¶„ì„ ì¿ í‚¤: ì–´ë–¤ ì¢…ë¥˜ ê²€ìƒ‰í•˜ëŠ”ì§€, ë§ì´ ê²€ìƒ‰í•˜ëŠ”ì§€, ì‹œê°„, ì–¸ì–´ ëŒ€ìƒ ë“±ì˜ ì •ë³´ë¥¼ ìˆ˜ì§‘

- ê´‘ê³  ì¿ í‚¤: ê²€ìƒ‰ ë‚´ìš©, êµ­ê°€ ,ì–¸ì–´ì— ë”°ë¼ ê´‘ê³  ê²Œì¬

ê·¸ë ‡ë‹¤ë©´ **Session**ì´ë€ ë¬´ì—‡ì¼ê¹Œìš”?

**ì„¸ì…˜(Session)** ì´ë€ ì‚¬ìš©ìê°€ ì›¹ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ ì›¹ì„œë²„ì— ì ‘ì†í•œ ì‹œì ìœ¼ë¡œë¶€í„° ì›¹ ë¸Œë¼ìš°ì €ë¥¼ ì¢…ë£Œí•˜ì—¬ ì—°ê²°ì„ ëë‚´ëŠ” ì‹œì ê¹Œì§€, ê°™ì€ ì‚¬ìš©ìë¡œë¶€í„° ì˜¤ëŠ” ì¼ë ¨ì˜ ìš”ì²­ì„ í•˜ë‚˜ì˜ ìƒíƒœë¡œ ë³´ê³ , **ê·¸ ìƒíƒœë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ëŠ” ê¸°ìˆ **ì„ ë§í•©ë‹ˆë‹¤.

ê³µí†°ì ê³¼ ì°¨ì´ì ì„ ê°„ë‹¨í•˜ê²Œ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

- **ê³µí†µì **: ì›¹ í†µì‹ ê°„ ìœ ì§€í•˜ë ¤ëŠ” ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ê²ƒ
- **ì°¨ì´ì **: ì €ì¥ìœ„ì¹˜, ì €ì¥í˜•ì‹, ìš©ëŸ‰ì œí•œ, ë§Œë£Œì‹œì  ë“±
  - **ì¿ í‚¤**: **ê°œì¸ PC**ì— ì €ì¥ë¨.
  - **ì„¸ì…˜**: ì ‘ì†ì¤‘ì¸ **ì›¹ ì„œë²„**ì— ì €ì¥ë¨.

ì™œ ì´ë ‡ê²Œ ë‚˜ëˆ ì„œ ì‚¬ìš©ì„ í• ê¹Œ í•˜ë©´ **ë³´ì•ˆìƒì˜ ë¬¸ì œì **ì„ ë³´ë©´ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Googleì„ ì‚¬ìš©í•œë‹¤ê³  ìƒê°í•´ ë´…ì‹œë‹¤.

ì¸í„°ë„·ì„ ì‚¬ìš©í•˜ë©´ì„œ google í˜ì´ì§€ëŠ” ì ‘ì†ì‹œë§ˆë‹¤ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.

**_ë§Œì•½ ì¿ í‚¤ë¥¼ í†µí•´ì„œ ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ID, ë¹„ë°€ë²ˆí˜¸ë¥¼ ê·¸ëŒ€ë¡œ ì¿ í‚¤ì— ì €ì¥í•˜ê²Œ ëœë‹¤ê³  ìƒê°í•´ ë´…ì‹œë‹¤._**

í˜ì´ì§€ ì´ë™ ì‹œì— **ì¿ í‚¤ë¥¼ í†µí•´ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì„œë²„ì— ì „ë‹¬**í•˜ê³ , **ì„œë²„ì—ì„œëŠ” í•´ë‹¹ ì‚¬ìš©ìë¥¼ ì‹ë³„í•˜ì—¬ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ìœ ì§€**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **_ì´ë¶€ë¶„ì— ëŒ€í•´ì„œëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤._**

í•˜ì§€ë§Œ, ì´ ë°©ì‹ì€ ì¿ í‚¤ê°€ ë…¸ì¶œë˜ì–´ ë³´ì•ˆ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ **ì„¸ì…˜(Session)** ì¸ ê²ƒì…ë‹ˆë‹¤.

**ì„¸ì…˜(Session)** ì€ ë¹„ë°€ë²ˆí˜¸ ê°™ì´ **ì¸ì¦ ì •ë³´ë¥¼** ì¿ í‚¤ì— ì €ì¥í•˜ì§€ ì•Šê³ , **ì‚¬ìš©ìì˜ ì‹ë³„ìì¸ Session IDë¡œ ì €ì¥**í•©ë‹ˆë‹¤.

**_ì„œë²„ì—ì„œëŠ” ì¸ì¦ ì •ë³´ì™€ ê°™ì´ ì´ IDì— í•´ë‹¹í•˜ëŠ” ë¡œê·¸ì¸ ìƒíƒœ, ì‹œê°„, ë‹‰ë„¤ì„, ë§Œë£Œê¸°í•œ ë“± ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤._**

**ì„œë²„ëŠ” í•´ë‹¹ ì„¸ì…˜IDë¡œ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ë³´ì•ˆìƒ ì•ˆì „ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ì°¸ê³ : [ì›¹ë¸Œë¼ìš°ì € ì¿ í‚¤ë€? - ì¿ í‚¤ ê°œë…, ì„¸ì…˜ ê°œë… (Cookie & Session) :: ì„¸ìƒì— ë„ì›€ì´ ë˜ëŠ” ë¸”ë¡œê·¸](https://lovefor-you.tistory.com/247)
[ì¿ í‚¤Cookieì™€ ì„¸ì…˜Session ì´ë€? ì°¨ì´ì .](https://cheershennah.tistory.com/135)

> ì´ëŸ¬í•œ ê²ƒë“¤ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” HTTPê°€ Stateless íŠ¹ì§•ì„ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì´ë‹¤.
> ì›¹ ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì˜ ì´ì „ ìƒíƒœë¥¼ ë³´ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì˜ë¯¸ë¥¼ ê°€ì§€ê³  ìˆë‹¤.

#### 4.2.2 ì„¸ì…˜ ì²˜ë¦¬ í™˜ê²½ êµ¬ì¶•

ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì¿ í‚¤ê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•˜ê³  ì‹¶ìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì´ í•˜ë©´ ëœë‹¤.

ê´€ë¦¬ì ë„êµ¬ -> inspect -> Application -> Storage -> Cookies

![cookies](./screenshot/cookies.png)

ì´ ì¿ í‚¤ê°€ ë¬´ìŠ¨ ì—­í• ì„ í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ **ë‘ê°€ì§€ ë°©ì‹**ìœ¼ë¡œ console.logë¥¼ ì‚¬ìš©í•´ ë³´ì•˜ë‹¤.

ì²« ë²ˆì§¸ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```js
app.use((req, res, next) => {
  console.log(req.headers);
  next();
});
```

ë§¨ ë°‘ì— ì¶œë ¥ì„ ë³´ë©´ cookieê°€ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![req-header](./screenshot/req-header.png)

ë‘ ë²ˆì§¸ ë°©ì‹ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

HomePageì— ë‘ ê°œì˜ ì¿ í‚¤ë¥¼ ë‹´ê³  sessionStoreë¥¼ í™•ì¸í•´ ë´¤ë‹¤.

```js
app.use((req, res, next) => {
  req.sessionStore.all((error, sessions) => {
    console.log(sessions);
    next();
  });
});
```

ì¿ í‚¤ì— ë‹´ê²¨ì ¸ì˜¨ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![sessions](./screenshot/console-sessionss.png)

ë§Œì•½ ì„œë²„ë¥¼ ì¢…ë£Œí•˜ê³  ë‹¤ì‹œ ì‹œì‘í•˜ë©´ ì´ ì„¸ì…˜ë“¤ì€ ì‚¬ë¼ì§„ë‹¤. **_ì•„ì§ ì´ ì„¸ì…˜ë“¤ì€ ë°ì´í„° ë² ì´ìŠ¤ì— ë„£ì–´ì ¸ ìˆëŠ”ê²ƒì´ ì•„ë‹Œ ì„œë²„ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì–´ ìˆê¸° ë•Œë¬¸ì´ë‹¤._**

ê·¸ë˜ì„œ í•„ìš”í•œ ì„¸ì…˜ë“¤ì„ ë°›ê³  ì €ì¥í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ì— ë„£ì–´ì£¼ëŠ” ê²ƒê¹Œì§€ ì´ë£¨ì–´ì ¸ì•¼ í•  ê²ƒ ê°™ë‹¤. ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ êµ¬í˜„í•´ ë³´ì.

NodeJSì—ì„œ Sessionì€ Express-session Middlewareë¥¼ í™œìš©í•˜ì—¬ ì„¸ì…˜ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

ì£¼ì˜í•  ì ì€ routerê°€ ë‚˜ì˜¤ê¸° ì „ì— ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²ƒì´ë‹¤.

server.js

```js
...

app.use(
  session({
    secret: "Hello!",
    resave: false,
    saveUninitialized: false,
  })
);

...
```

**resave** ì™€ **saveUninitialize**ê°€ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

**resave?**

ëª¨ë“  requestë§ˆë‹¤ ê¸°ì¡´ì— ìˆë˜ sessionì— ì•„ë¬´ëŸ° ë³€ê²½ì‚¬í•­ì´ ì—†ì„ ì‹œì—ë„ ê·¸ sessionì„ ë‹¤ì‹œ ì €ì¥í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤. **(ë§¤ request ë§ˆë‹¤ ì„¸ì…˜ì„ ê³„ì† ì €ì¥í•˜ëŠ” ê²ƒ.)**

**saveUninitialized?**

requestê°€ ë“¤ì–´ì˜¤ë©´ í•´ë‹¹ requestì—ì„œ ìƒˆë¡œ ìƒì„±ëœ sessionì— ì•„ë¬´ëŸ° ì‘ì—…ì´ ì´ë£¨ì–´ì§€ì§€ ì•Šì€ ìƒí™©ì„ ë§í•©ë‹ˆë‹¤. **ì´ê²ƒì„ trueë¡œ í•´ë†“ìœ¼ë©´** uninitialized ìƒíƒœì˜ sessionì„ ê°•ì œë¡œ ì €ì¥í•©ë‹ˆë‹¤. **_ë”°ë¼ì„œ ì•„ë¬´ ë‚´ìš© ì—†ëŠ” sessionì´ ê³„ì†í•´ì„œ ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤._**

ì°¸ê³ : [express-session íŒ¨í‚¤ì§€ì˜ resave, saveUninitialized ì˜µì…˜](https://fierycoding.tistory.com/36)

**Session Id**ëŠ” ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ëŠ” ê²ƒì¸ê°€?

ë§Œì•½ ë‚´ê°€ homepageì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ í•´ë†“ê³  ìƒˆë¡œê³ ì¹¨ì„ ì—¬ëŸ¬ë²ˆ í–ˆë‹¤ê³  ìƒê°í•´ ë³´ì.

```js
app.get("/add-one", (req, res, next) => {
  req.session.potato += 1;
  return res.send(`${req.session.id}`);
});
```

![session-id-process](./screenshot/session-Id-process.png)

ì°¸ê³ ë¡œ í•˜ë‚˜ëŠ” ì¼ë°˜ í¬ë¡¬ìœ¼ë¡œ í•˜ë‚˜ëŠ” ì‹œí¬ë¦¿ ëª¨ë“œë¡œí•´ì„œ ìƒˆë¡œê³ ì¹¨ì„ ëª‡ë²ˆì”© í•œ ê²ƒì´ë‹¤.

ì´ì™€ ê°™ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì›¹ì‚¬ì´íŠ¸ë¥¼ ì²˜ìŒ ë°©ë¬¸í•  ë•Œ **Session Middelware**ê°€ ìˆìœ¼ë©´ **express**ê°€ ì•Œì•„ì„œ ê·¸ ë¸Œë¼ìš°ì €ë¥¼ ìœ„í•œ **Session Id**ë¥¼ ë§Œë“¤ê³  ë¸Œë¼ìš°ì €í•œí…Œ ë³´ë‚´ì¤€ë‹¤. ê·¸ëŸ¬ë©´ ë¸Œë¼ìš°ì €ê°€ **ì¿ í‚¤ì— Session Idë¥¼ ì €ì¥**í•˜ê³  **expressì—ì„œ ë˜í•œ ì´ Sessionì„ Session DBì— ì €ì¥**í•  ê²ƒì´ë‹¤. ì´ì œ ë¸Œë¼ìš°ì €ëŠ” ì›¹ì‚¬ì´íŠ¸ë¥¼ ë°©ë¬¸í•  ë•Œ ë§ˆë‹¤ **requestì™€ í•¨ê»˜ Session Id**ë¥¼ í•¨ê»˜ ë³´ë‚¼ ê²ƒì´ë‹¤. ê·¸ëŸ¬ë©´ **ì„œë²„(ë°±ì—”ë“œ)** ì—ì„  ì–´ë–¤ ìœ ì €ê°€ ì–´ë–¤ ë¸Œë¼ìš°ì €ì—ì„œ ìš”ì²­ì„ ë³´ëƒˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤.

#### 4.2.3 ì„¸ì…˜ ì²˜ë¦¬

í˜„ì¬ sessionì— ë³€ê²½ ì‚¬í•­ì´ ìˆì„ ë•Œ ë‹¤ì‹œ ì €ì¥í•˜ë„ë¡ í•´ë†“ì•˜ìŠµë‹ˆë‹¤. sessionì„ ì €ì¥í•  í•„ìš”ê°€ ìˆëŠ” ì‹œì ì´ ì–¸ì œì¼ê¹Œ? ê·¸ê²ƒì€ ë¡œê·¸ì¸ í•  ë•Œ ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ controllerë¡œ ê°€ì„œ postLogin functionì— ì½”ë“œë¥¼ ì¶”ê°€í•´ ë†“ìœ¼ë©´ ë©ë‹ˆë‹¤.

userController.js

```js
export const postLogin = async (req, res) => {
  const { username, password } = req.body;
  const pageTitle = "Login";
  const user = await User.findOne({ username });
  if (!user) {
    return res.status(400).render("login", {
      pageTitle,
      errorMessage: "An account with this username dose not exists.",
    });
  }
  const ok = await bcrypt.compare(password, user.password);
  if (!ok) {
    return res.status(400).render("login", {
      pageTitle,
      errorMessage: "Wrong Password",
    });
  }
  req.session.loggenIn = true;
  req.session.user = user;
  return res.redirect("/");
};
```

ì´ì™€ ê°™ì´ í•´ì£¼ë©´ loginí–ˆì„ ë•Œ Sessionì˜ ì¶œë ¥ì€ ë‹¤ìŒê³¼ ê°™ì´ ë‚˜ì˜¨ë‹¤.

![print session](./screenshot/print-session.png)

ì ì´ë ‡ê²Œ ë°±ì—”ë“œëŠ” ì´ì œ ì´ ìœ ì €ê°€ ì´ ì›¹ì‚¬ì´íŠ¸ì˜ ì–´ëŠ URLì„ ì´ë™í•˜ë˜ ê°„ë° ì´ ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆì„ ê²ƒì´ë‹¤. í•˜ì§€ë§Œ ì—¬ê¸°ì„œ ë‘ê°€ì§€ ë¬¸ì œì ì´ ìˆë‹¤. ì´ ì •ë³´ëŠ” **ë°±ì—”ë“œì—ì„œ ê°€ì§€ê³  ìˆëŠ” ê²ƒìœ¼ë¡œ ì•„ì§ Template(í”„ë¡ íŠ¸)ì€ ë°›ì§€ ëª»í•œ ì •ë³´**ì´ë‹¤. ë˜í•œ **ëª¨ë“  URLì—ì„œ ì´ ì •ë³´ë¥¼ ë°›ê²Œ** í•´ì¤˜ì•¼ í•œë‹¤.

ê·¸ë˜ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒì´ **res.locals**ì´ë‹¤.

> req.locals
>
> > ëª¨ë“  í˜ì´ì§€(í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)ì—ì„œ ì´ ê°ì²´ì— ë„£ì–´ì¤€ ê²ƒì€ ì „ë¶€ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì¦‰, ì´ ê°ì²´(í•¨ìˆ˜)ë¥¼ ì“°ë©´ ë Œë”ë§ì‹œ ì¤‘ë³µë˜ëŠ” ê°’ë“¤ì„ ì €ì¥í•´ë†“ê³  ê³„ì†í•´ì„œ ì“¸ ìˆ˜ ìˆëŠ” ê²ƒì´ë‹¤.

ì´ê²ƒì„ ì´ìš©í•´ì„œ **global Middleware**ë¥¼ ë§Œë“¤ì–´ ì¤„ ìˆ˜ ìˆë‹¤.

middlewares.js

```js
export const localsMiddleware = (req, res, next) => {
  res.locals.siteName = "Wetube";
  res.locals.loggedIn = Boolean(req.session.loggedIn);
  res.locals.loggedInUser = req.session.user;
  next();
};
```

ì½”ë“œ ë¶„ì„ì„ ì¡°ê¸ˆ í•´ë³´ìë©´ **Boolean()ì„ ì‚¬ìš©í•œ ì´ìœ **ëŠ” req.session.loggedInì— True, Falseê°€ ì•„ë‹Œ **undefined**ë¡œ ë“¤ì–´ê°€ ìˆì„ ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ì´ë ‡ê²Œ í•´ì¤€ ê²ƒì´ë‹¤.

ì´ë ‡ê²Œ í•´ì¤Œìœ¼ë¡œì¨ ëª¨ë“  Templateì—ì„œ ì‚¬ìš©ê°€ëŠ¥í•´ì¡Œë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ë©´ ëœë‹¤.

base.pug

```pug
doctype html
html(lang="ko")
    head
        title #{pageTitle} | #{siteName}
        link(rel="stylesheet" href="https://unpkg.com/mvp.css")
    body
        header
            h1=pageTitle
            nav
                ul
                    li
                        a(href="videos/upload") Upload Video
                    if loggedIn
                        li
                            a(href="/logout") Log Out
                        li
                            a(href="/my-profile") #{loggedInUser.name}ì˜ Profile
                    else
                        li
                            a(href="/join") Join
                        li
                            a(href="/login") Login
                    li
                        a(href="/") Home
                    li
                        a(href="/search") Search
        main
            block content
    include partials/footer.pug
```

ì´ì œ ì„¸ì…˜ì€ ëª¨ë“  í”„ë¡ íŠ¸ ì‚¬ì´ë“œì—ì„  ìœ íš¨í•´ì¡Œë‹¤.

í•˜ì§€ë§Œ ì„œë²„ë¥¼ ì¢…ë£Œí•˜ê³  ì¬ì‹œì‘í•˜ë©´ ì„¸ì…˜ì´ ì‚¬ë¼ì§€ê³ ë§Œë‹¤. ì´ ë¬¸ì œì ì„ í•´ê²°í•´ ë³´ì.

#### 4.2.4 Session connect-mongo

**_í˜„ì¬ Session dataì˜ ê²½ìš° server-sideì— ì €ì¥ë˜ê¸°ëŠ” í•˜ì§€ë§Œ ì´ê²ƒì€ MongoDBë¥¼ ì˜ë¯¸í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë‹¤._**

ì„œë²„ì— ì €ì¥ë˜ëŠ” **dafault session storage**ëŠ” **MeomoryStore**ì´ê³ , ì‹¤ì œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ìˆëŠ”ê²ƒì€ ì•„ë‹ˆë‹¤.

ê·¸ë˜ì„œ **Session**ì„ **MongoDB**ì— ì €ì¥í•˜ê¸°ìœ„í•´ì„œ **connect-mongo**ë¥¼ ì‚¬ìš©í•œë‹¤. ì„¤ì¹˜ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

    npm i connect-mongo

MongoStoreë¥¼ importí•˜ëŠ” ë²•ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

    import MongoStore from "connect-mongo"

mongo databaseì˜ URLì„ ê°€ì§€ê³  ìˆëŠ” **Configuration object**ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

server.js

```js
app.use(
  session({
    secret: "Hello!",
    resave: false,
    saveUninitialized: false,
    store: MongoStore.create({ mongoUrl: "mongodb://127.0.0.1:27017/wetube" }),
  })
);
```

ì´ë ‡ê²Œ í•´ì¤Œìœ¼ë¡œì¨ ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ë„ ë¡œê·¸ì¸ì´ ë˜ì–´ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

> ë³„ ë‹¤ë¥¸ ì½”ë“œ ìˆ˜ì •ì—†ì´ ë°±ì—”ë“œ ë©”ëª¨ë¦¬ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ DBì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” ê²ƒìœ¼ë¡œ ë°”ê¿”ì§€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ìˆë‹¤.

> ë™ì‘ ì›ë¦¬ë¥¼ í•œë²ˆë§Œ ë” í™•ì¸í•´ ë³´ì.
>
> app.use(session({})) ì´ Middlewareê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì¡°ìš©íˆ reqê°ì²´ì˜ Propertyë¡œ sessionì´ë¼ê³  í•˜ëŠ” ê°ì²´ë¥¼ ì¶”ê°€í•´ ì£¼ëŠ”ê²ƒìœ¼ë¡œ ìƒê°í•´ ë³´ë©´ëœë‹¤.
>
> ê·¸ë ‡ê²Œ ìƒê°í•˜ë©´ storeë¥¼ MongoDBì— í•˜ë“  ì„œë²„ Memoryì— í•˜ë“  Routerì— ë„ë‹¬í•˜ê¸° ì „ Middlewareì—ì„œ ì–´ë””ë¡œ ì €ì¥í–ˆëŠ”ì§€ í™•ì¸ í›„ êº¼ë‚´ì™€ì„œ req.sessionì— ë„£ì–´ì£¼ë©´ ë˜ë¯€ë¡œ ì½”ë“œ ìˆ˜ì •ì´ í•„ìš” ì—†ë‹¤ê³  ìƒê°ëœë‹¤.

**Store Option**ì€ ì €ì¥ ë°©ì‹ìœ¼ë¡œ MongoStore.create() ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ MongoDB URLì„ ì§€ì •í•´ì¤€ ê²ƒì´ë‹¤. ì´ì œ ì„¸ì…˜ì€ MongoDBì•ˆì— ë§Œë“¤ì–´ ì§ˆ ë•Œ ë³´ê´€ëœë‹¤.

![Session in MongoDB](./screenshot/mongoDB-session.png)

**ISODate**ì˜ ê²½ìš° ì´ ë‚ ì§œ ì´í›„ë¡œ ë°ì´í„°ë¥¼ ì§€ìš°ê² ë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.

**secret**ì˜ ê²½ìš° íŠ¹ì • ë¬¸ìì—´ì„ ì´ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì•”í˜¸í™”í•œ í›„ ì¿ í‚¤ì— ì €ì¥í•˜ê²Œ ëœë‹¤.

> secretì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
>
> > ìš°ë¦¬ê°€ ì¿ í‚¤ì— sign í•  ë•Œ ì‚¬ìš©í•˜ëŠ” Stringì„ secretì´ë¼ê³  í•˜ëŠ”ë°, ì´ê²ƒì„ í•˜ëŠ” ì´ìœ ëŠ” backendê°€ ì¿ í‚¤ë¥¼ ì¤¬ë‹¤ëŠ” ê²ƒì„ ë³´ì—¬ì£¼ê¸° ìœ„í•¨ì´ë‹¤. session hijackì´ë¼ëŠ” ê³µê²© ìœ í˜•ì´ ìˆëŠ”ë° ëˆ„êµ°ê°€ ë„ˆì˜ ì¿ í‚¤ë¥¼ í›”ì³ ë„ˆì¸ì²™ í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ secretì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

ì—¬ê¸°ì„œ ë¬¸ì œì ì€ ê·¸ë ‡ì œ ì¤‘ìš”í•œ ë¬¸ìì—´ì„ ì €ë ‡ê²Œ ëŒ€ë†“ê³  ì¨ë†“ì€ ìƒíƒœë¡œ ì½”ë“œ ë°°í¬ë¥¼ í•˜ë©´ ë¬¸ì œê°€ ìƒê¸¸ ê²ƒì´ë‹¤.

ì´ê²ƒì€ .envë¡œ í•´ê²°ì„ í•  ê²ƒì´ë‹¤.

### 4.3 .env

NodeJSì—ì„œ í”„ë¡œê·¸ë˜ë°ì— í•„ìš”í•œ ê°’ë“¤ì„ ì„œìˆ í•  ìˆ˜ ìˆëŠ” **í™˜ê²½ë³€ìˆ˜ íŒŒì¼(enviornment file)** ì„ ë§í•œë‹¤.

#### 4.3.1 í™œìš©ë²•

.envì—ëŠ” ë³´í†µ **ë°°í¬ë˜ë©´ ì•ˆë˜ëŠ” ê°’ë“¤**ì„ ë„£ì–´ì¤€ë‹¤. ê·¸ë¦¬ê³  ê´€ìŠµì ìœ¼ë¡œ envíŒŒì¼ì— ì¶”ê°€í•˜ëŠ” ëª¨ë“  ê²ƒë“¤ì€ **ëŒ€ë¬¸ì**ë¡œ ì ì–´ì¤˜ì•¼ í•œë‹¤.

envíŒŒì¼ì— ìˆëŠ” ê°’ë“¤ì„ ë„£ì–´ì£¼ê³  ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„  ìš°ì„  dotenvë¥¼ ì„¤ì¹˜í•´ ì¤˜ì•¼í•œë‹¤.

    $ npm i doetenv

**envë¥¼ importí• ë•Œ ì£¼ì˜í•  ì **ì€ ë‹¤ìŒê³¼ ê°™ì´ ì¨ì ¸ìˆë‹¤.

> As early as possible in your application, require and configure dotenv.

package.jsonì— ê°€ë³´ë©´ í™•ì¸ì„ í•  ìˆ˜ ìˆë‹¤.

```js
  "scripts": {
    "dev": "nodemon --exec babel-node src/init.js"
  },
```

í˜„ì¬ srcí´ë”ì— ìˆëŠ” init.jsë¥¼ ê°€ì¥ ë¨¼ì € ì‹¤í–‰í•˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ê·¸ë˜ì„œ init.jsì— importë¥¼ í•´ì£¼ë©´ ëœë‹¤.

init.js

```js
require("dotenv").config();
```

> ì´ ë°©ì‹ìœ¼ë¡œ í–ˆì„ ë•Œ ì˜¤ë¥˜ê°€ ë°œìƒ í•  ìˆ˜ ìˆëŠ”ë° ì´ì „ì— importí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë‹¤ìŒì˜ ë°©ì‹ì„ ì‚¬ìš©í•´ ì™”ë‹¤.
>
> > import "dotenv/config";
>
> **requireê³¼ importê°€ ì¤‘ë³µë˜ì„œ ì‚¬ìš©**ë˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒ í• ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜í•˜ì.
>
> ì¶”ê°€ì ìœ¼ë¡œ ì£¼ì˜í•  ê²ƒì€ **ê°€ì¥ ë¨¼ì € import**í•´ì¤˜ì•¼ í•˜ëŠ” ê²ƒì— ì£¼ì˜í•˜ì.

envíŒŒì¼ì„ ë§Œë“¤ê³ , ì—¬ê¸°ì— ëª¨ë“  **API key**ë‚˜ **ë¹„ë°€ë¡œ í•´ì•¼ ë˜ëŠ” ê°’**ì„ ë„£ì–´ì¤˜ ë³´ì.

.env

```env
COOKIE_SECRET=asdlnfklasidhjkfbklasjdnfjionxcova
DB_URL=http://secret.url
```

envíŒŒì¼ì— ìˆëŠ” ê°’ë“¤ì„ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ë©´ ëœë‹¤.

server.js

```js
...

app.use(
  session({
    secret: process.env.COOKIE_SECRET,
    resave: false,
    saveUninitialized: false,
    store: MongoSotre.create({ mongoUrl: process.env.DB_URL }),
  })
);

...
```

## 5. ì†Œì…œ ë¡œê·¸ì¸ êµ¬í˜„

ì†Œì…œ ë¡œê·¸ì¸ì´ë€ êµ­ë‚´ì™¸ ëŒ€í‘œ í¬í„¸ ì‚¬ì´íŠ¸, ì†Œì…œ ë¯¸ë””ì–´ ë“±ì˜ ê³„ì • ì •ë³´ë¥¼ ì´ìš©í•´ ë‹¤ë¥¸ ì—¬ëŸ¬ ì¸í„°ë„· ì„œë¹„ìŠ¤ë¥¼ ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì…í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ë§í•œë‹¤. **ë„¤ì´ë²„, ì¹´ì¹´ì˜¤, í˜ì´ìŠ¤ë¶, êµ¬ê¸€, ì• í”Œ, ê¹ƒí—ˆë¸Œ, ë“±ë“±** êµ‰ì¥íˆ ë§ì€ ì„œë¹„ìŠ¤ì—ì„œ ì§€ì›ì„ í•´ì£¼ê³  ìˆë‹¤. ì´ì¤‘ì— ê¹ƒí—ˆë¸Œë¥¼ ì´ìš©í•´ì„œ êµ¬í˜„ì„ í•  ê²ƒì´ë‹¤.

### 5.1 Github ë¡œê·¸ì¸ ë™ì‘ ì›ë¦¬

Githubì˜ ê²½ìš° ë‹¤ìŒê³¼ ê°™ì´ ë™ì‘í•œë‹¤ê³  ë³´ë©´ ëœë‹¤.

1. ì„œë²„ì—ì„œ ìœ ì €ë¥¼ Githubë¡œ ë³´ë‚´ì¤€ë‹¤.
2. ì •ë³´ë¥¼ ê³µìœ í•˜ëŠ” ìŠ¹ì¸ ê³¼ì •ì„ ê±°ì¹œí›„ Githubì—ì„œ ë‹¤ì‹œ ì‚¬ìš©ìë¥¼ ìš°ë¦¬ ì›¹ì‚¬ì´íŠ¸ë¡œ ëŒë ¤ ë³´ë‚´ì¤€ë‹¤.
3. ëŒë ¤ ë³´ë‚´ì£¼ëŠ” ê³¼ì •ì—ì„œ tokenê³¼ í•¨ê»˜ ë³´ë‚´ì¤Œìœ¼ë¡œì¨ ì„œë²„ì—ì„œ ê·¸ tokenìœ¼ë¡œ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” ê²ƒì´ë‹¤.

ìì„¸í•œ ë‚´ìš©ì€ ê³¼ì •ì„ ì‚´í´ë³´ë©´ì„œ í™•ì¸í•´ë³´ì.

### 5.2 Githubì— ë“±ë¡í•˜ê¸°.

githubì˜ ì†Œì…œë¡œê·¸ì¸ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” githubì˜ OAuthë¥¼ ì‚¬ìš©í•´ì•¼í•˜ê³  ë“±ë¡ ê³¼ì •ì„ ê±°ì³ì•¼ í•œë‹¤.

- ë³´í†µ ê²€ìƒ‰ì°½ì— ë°”ë¡œ **ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” ì†Œì…œì„œë¹„ìŠ¤ì™€ OAuthë¥¼ ê²€ìƒ‰**í•˜ë©´ í•´ë‹¹ í˜ì´ì§€ë¡œ ë°”ë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë‹¤.
- githubì˜ ê²½ìš°, OAuth ë“±ë¡ì„ ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì´ í•´ì¤€ë‹¤.
  - 1. ë¡œê·¸ì¸
  - 2. my pageì˜ settings
  - 3. developer setting
  - 4. OAuth App í´ë¦­
  - 5. New OAuth App í´ë¦­

ì´ ê³¼ì •ì„ ê±°ì¹˜ê³  ë‚˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì´ ë‚˜ì˜¬ ê²ƒì´ë‹¤.

ìì„¸í•œ ë‚´ìš©ì€ [í™ˆí˜ì´ì§€](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps)ë¥¼ ì°¸ê³ í•˜ì.

![New OAuth App](./screenshot/new-oauth-app.png)

ìˆœì„œëŒ€ë¡œ ì‘ì„±í•´ ì£¼ë©´ ë˜ê³  ì—¬ê¸°ì„œ **Authorization callback URL**ì— ì‘ì„±í•´ì•¼ í•  ê²ƒì€ [ì•„ë˜](#521-oauth-application)ì— ì ì–´ë†“ì•˜ë‹¤.

#### 5.2.1 OAuth Application

![OAuth Application](./screenshot/Register-OAuth.png)

í•˜ë‚˜ì”© ì„¤ëª…í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

- **Client ID**: ë‚´ê°€ êµ¬í˜„ í•  Applicationì¸ Clientë¥¼ ì‹ë³„ í•  ìˆ˜ ìˆëŠ” ID
- **Client Secret**: ë‚´ê°€ êµ¬í˜„ í•  Applicationì¸ Clientë¥¼ ì‹ë³„ í•  ìˆ˜ ìˆëŠ” PW(ì ˆëŒ€, ì½”ë“œì— ë…¸ì¶œë˜ë©´ ì•ˆë˜ëŠ” ì •ë³´!)
- **Homepage URL**: ë‚´ ì„œë¹„ìŠ¤ì˜ URL
- **Authorization callback URL**: ì‚¬ìš©ìê°€ Githubë¡œê·¸ì¸ì„ í•˜ë©´ Redirectë  í˜ì´ì§€ì˜ ì£¼ì†Œ.

### 5.3 Githubë¡œ ìœ ì € ì „ì†¡

ìœ ì €ë¥¼ Githubë¡œ ë³´ë‚´ì£¼ê¸° ìœ„í•´ì„œ í˜ì´ì§€ ì´ë™ì„ í•  ìˆ˜ ìˆë„ë¡ í”„ë¡ íŠ¸ì—ì„œ ìˆ˜ì •ì„ í•´ì¤˜ì•¼ í•œë‹¤.

anchorë¥¼ ì´ìš©í•˜ë©´ ë˜ê³  URLì˜ ê²½ìš° í™ˆí˜ì´ì§€ì— ë‚˜ì™€ìˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ë©´ ëœë‹¤.

login.pug

```pug
...
a(href="https://github.com/login/oauth/authorize") Continue with Github &rarr;
...
// ìœ„ ì•„ë˜ ì½”ë“œëŠ” ìƒëµí•˜ê² ë‹¤.
```

ì´ ë§í¬ë¥¼ íƒ€ê³  ì´ë™í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜ì´ì§€ë¥¼ ë§Œë‚  ê²ƒì´ë‹¤.

![404 Not Found](./screenshot/404--Not-Found.png)

ì´ê²ƒì€ í˜„ì¬ ë³´ë‚´ì¤˜ì•¼í•  parameterë¥¼ ë³´ë‚´ì£¼ì§€ ì•Šì•„ì„œ ê·¸ëŸ° ê²ƒì´ë‹¤.

urlì„ ì´ì™€ê°™ì´ í•´ì„œ ë³´ë‚´ì£¼ë©´ ëœë‹¤.

"https://github.com/login/oauth/authorize?client_id=[ìœ„ì—ì„œ ë°›ì€ client id]&allow_signup=false&scope= "

ì—¬ê¸°ì„œ ë¬¸ì œì ì´ ë°œìƒí•œë‹¤. **allow_sighup**ì€ ì‚¬ìš©ìê°€ Github ê³„ì •ì´ ì—†ë‹¤ë©´ ê³„ì • ìƒì„±ì„ í•  ìˆ˜ ì‡ë„ë¡ í•´ì¤„ ê²ƒì¸ì§€ ì•„ë‹ˆë©´ ê³„ì • ìˆëŠ” ì‚¬ëŒë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•  ê²ƒì¸ì§€ë¥¼ ì •í•´ì¤€ë‹¤. **scope**ì—ëŠ” ìœ ì €ì—ê²Œì„œ ì–¼ë§ˆë‚˜ ë§ì€ ì •ë³´ë¥¼ ì½ì–´ë‚´ê³  ì–´ë–¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ê²ƒì¸ê°€ì— ëŒ€í•œ ê²ƒì„ ì ì–´ì£¼ëŠ” ê²ƒì´ë‹¤. **scopeì˜ ê²½ìš° ê³µë°±**ìœ¼ë¡œ êµ¬ë¶„í•œë‹¤. ì´ì™¸ì—ë„ ParametersëŠ” **redirect_url**, **login**, **state**ê°€ ìˆë‹¤. ì´ëŸ¬í•œ ê²ƒì„ í•œ stringìœ¼ë¡œ anchorì•ˆì— ë„£ì–´ì¤€ë‹¤ë©´ ê°€ë…ì„±ì´ ë§¤ìš° ë‚˜ë¹ ì§€ê³  ê´€ë¦¬í•˜ê¸°ë„ ì•ˆ ì¢‹ì•„ì§ˆ ê²ƒì´ë‹¤.

#### 5.3.1 ê°€ë…ì„± ì¢‹ì€ ì½”ë“œë¡œ ìˆ˜ì •

ê°€ë…ì„± ì¢‹ì€ ì½”ë“œë¡œ ìˆ˜ì •í•˜ê¸° ìœ„í•´ì„œ í•  ìˆ˜ ìˆëŠ” ê²ƒì„ ìƒê°í•´ ë³´ì. linkë¥¼ íƒ€ê³  ì´ë™ì„ í–ˆì„ ë•Œ ê·¸ í˜ì´ì§€ì˜ controllerì—ì„œ ì½”ë“œë¥¼ ê¹”ë”í•˜ê²Œ ìˆ˜ì •í•˜ê³  redirectë¥¼ ì´ìš©í•´ì„œ í˜ì´ì§€ ì´ë™ì„ í•´ì£¼ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¤.

ë¨¼ì €, pugë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•´ ì¤€ë‹¤.

```pug
a(href="/users/github/start") Continue with Github &rarr;
```

ë‹¤ìŒì€ Routerë¥¼ ì†ë´ì¤€ë‹¤.

userRouter.js

```js
userRouter.get("/github/start", startGithubLogin);
```

ë§ˆì§€ë§‰ìœ¼ë¡œ controllerì—ì„œ ì²˜ë¦¬í•´ì£¼ë©´ ë˜ê² ë‹¤.

userController.js

```js
export const startGithubLogin = (req, res) => {
  const baseUrl = `https://github.com/login/oauth/authorize`;
  const config = {
    clientId: "[ìœ„ì—ì„œ ë°›ì€ client id]",
    allow_signup: false,
    scope: "read:user user:email",
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
  return res.redirect(finalUrl);
};
```

ì½”ë“œ ë¶„ì„ì„ í•´ë³´ì.

[URLSearchParams](https://developer.mozilla.org/ko/docs/Web/API/URLSearchParams)ì˜ ê²½ìš° **ê°ì²´ ë˜ëŠ” ë°°ì—´ì„ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë“¤ë¡œ ìˆ˜ì •**í•˜ê±°ë‚˜ í˜¹ì€ **URLì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë“¤ì„ ì½ì„ ë•Œ** ì‚¬ìš©í•©ë‹ˆë‹¤.

[toString()](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/Object/toString)ì€ ë¬¸ìì—´ì„ ë°˜í™˜í•˜ëŠ” Objectì˜ ëŒ€í‘œì ì¸ ë°©ë²•ì´ë‹¤.

ì´ì™€ê°™ì´ baseUrlê³¼ paramsë¥¼ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì¤€ ë‹¤ìŒ ë§ˆì§€ë§‰ì´ finalUrlë¡œ í•©ì³ì„œ í•´ë‹¹ í˜ì´ì§€ë¡œ redirectí•´ì¤Œìœ¼ë¡œ ì¨ **ì½”ë“œì˜ ê°€ë…ì„±ì´ ë†’ì•„ì§€ê³  ìœ ì§€ ë³´ìˆ˜í•˜ê¸° í¸í•´ì§„ ê²ƒ**ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜ˆì‹œëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![URLSearchParams toString](./screenshot/URLSearchParams.png)

ì´ì œ í˜ì´ì§€ë¥¼ ì´ë™í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![Authorize](./screenshot/Authorize.png)

### 5.4 Access Token

ìŠ¹ì¸ì„ í•´ì£¼ë©´ ë‹¤ìŒê³¼ ê°™ì€ í˜ì´ì§€ë¡œ ì´ë™ì„ í•˜ê²Œ ëœë‹¤.

![Callback Post](./screenshot/callback-post.png)

ì´ URLì˜ ê²½ìš° ì•„ê¹Œ [ìœ„ì—ì„œ](#521-oauth-application) ë´¤ë˜ Authorization callback URLì¼ ê²ƒì´ë‹¤. ìœ ì €ê°€ ê¹ƒí—ˆë¸Œì—ì„œ ìŠ¹ì¸ì„ ë°›ê³  ì¸ì¦ì´ ëìœ¼ë©´ **Tokenì„ ê°€ì§€ê³  í•´ë‹¹ URLë¡œ redirectí•´ì„œ ì´ë™ì„ í•˜ëŠ” ê²ƒ**ì´ë‹¤.

**_ê·¸ë ‡ë‹¤ë©´ Tokenì€ ì–´ë””ìˆëŠ”ê°€?_**

ìœ„ì— URLì„ ì‚´í´ë³´ë©´ codeì•ˆì— valueê°’ì´ ë“¤ì–´ê°€ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ê²ƒì€ temporary codeë¡œ 10ë¶„ í›„ì— ë°˜ë£Œë˜ëŠ” codeì´ë‹¤. ì´ê²ƒì„ Access Tokenìœ¼ë¡œ êµí™˜í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤. ì´ê²ƒë„ ìœ„ì˜ ë°©ì‹ê³¼ ë™ì¼í•˜ê²Œ [í™ˆí˜ì´ì§€](https://docs.github.com/en/developers/apps/building-oauth-apps/authorizing-oauth-apps)ì—ì„œ ì¤€ baseURLì„ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬í•´ì£¼ë©´ ëœë‹¤.

routerì— getë©”ì†Œë“œë¥¼ ì¶”ê°€í•´ì£¼ê³  controllerë¥¼ ìˆ˜ì •í•´ì£¼ë©´ ëœë‹¤.

userRouter.js

```js
userRouter.get("/github/callback", finishGithubLogin);
```

userController.js

```js
export const finishGithubLogin = (req, res) => {
  const baseUrl = "https://github.com/login/oauth/access_token";
  const config = {
    client_id: process.env.GH_CLIENT,
    client_secret: process.env.GH_CLIENT,
    code: req.query.code,
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
};
```

ì´ URLì€ redirectë¥¼ í•˜ë ¤ê³  ë§Œë“  URLì´ ì•„ë‹ˆë‹¤.

ì´ íŠ¹ì • URLë¡œë¶€í„° ì •ë³´ë¥¼ ë°›ì•„ì˜¤ê¸° ìœ„í•¨ì´ë‹¤. ê·¸ëŸ´ ë•Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ fetch APIì´ë‹¤.

#### 5.4.1 Fetch

ì›¹ ê°œë°œì„ í•  ë•Œ, ajaxí†µì‹ ì„ ìì£¼ ì‚¬ìš©í•˜ê²Œ ëœë‹¤. ajaxë¥¼ ì‚¬ìš©í•  ë•Œ, **XHR, JQuery, Fetch**ë¥¼ ì“¸ ìˆ˜ ìˆë‹¤.

**fetchë€** ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì„œë²„ë¡œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­(request)ë¥¼ ë³´ë‚´ê³  ì‘ë‹µ(response)ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ë©”ì„œë“œ

XMLHttpRequestì™€ ë¹„ìŠ·í•˜ì§€ë§Œ fetchëŠ” **Promise ê¸°ë°˜**ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆì–´ì„œ ë” ê°„í¸í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

**ë¹„ë™ê¸° ìš”ì²­**ì˜ ê°€ì¥ ëŒ€í‘œì ì¸ ì‚¬ë¡€ë¥¼ ê¼½ìœ¼ë¼ê³  í•œë‹¤ë©´, ë‹¨ì—° **ë„¤íŠ¸ì›Œí¬ ìš”ì²­**ì„ ë“¤ ìˆ˜ ìˆë‹¤. ë‹¤ì–‘í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì¤‘, **URLë¡œ ìš”ì²­**í•˜ëŠ” ê²½ìš°ê°€ ê°€ì¥ í”í•˜ë‹¤. ì´ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•´ì£¼ëŠ” APIê°€ ë°”ë¡œ **fetch API**ë‹¤

ì°¸ê³ : [[Node.js] fetch API / SPRINT-ë¹„ë™ê¸°ğŸ’¯ï¸](https://velog.io/@delilah/Node.js-fetch-API)

fetchì˜ ê²½ìš° ì›ë˜ ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë©”ì†Œë“œì´ë‹¤. NodeJSì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„  ì„¤ì¹˜ë¥¼ í•´ì£¼ì–´ì•¼ í•œë‹¤.

    $ npm install node-fetch

> **[ERR_REQUIRE_ESM] Error í•´ê²°** <br />
> node-fetchê°€ Version 3ë¥¼ ë‚´ë©´ì„œ npm install node-fetchë¥¼ í•˜ë©´, version 3.0.0ì´ ì„¤ì¹˜ë©ë‹ˆë‹¤. <br />
> í˜„ì¬ ì„¤ëª…í•˜ê³  ìˆëŠ” **versionì€ 2.6.1 ê¸°ì¤€**ì…ë‹ˆë‹¤. <br />
> Version 3ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ì‹¤í–‰ì‹œí‚¤ë©´, ì•„ë§ˆ **[ERR_REQUIRE_ESM]** ê°€ ëœ°ê²ë‹ˆë‹¤. <br />
> ì´ê²ƒì€ node-fetchê°€ Version 3ë¶€í„°ëŠ” **ESM-only Module**ì´ì–´ì„œ ê·¸ëŸ° ê²ƒ ê°™ìŠµë‹ˆë‹¤. <br />
> ê³µì‹ë¬¸ì„œì—ì„œëŠ” CSM(CommonJS)ë¥¼ ì“°ëŠ” ì‚¬ëŒë“¤ì€ ë²„ì „ 2ë¡œ ì“¸ ê²ƒì„ ê¶Œì¥í•œë‹¤ê³  í•©ë‹ˆë‹¤. <br />
> ì´ë¯¸ ì„¤ì¹˜í•˜ì…¨ìœ¼ë©´, npm uninstall node-fetchë¡œ ì œê±°í•˜ì‹œê³  npm install node-fetch@2.6.1 ëª…ë ¹ì–´ ì‹¤í–‰í•˜ì‹œë©´ ì˜¤ë¥˜ê°€ í•´ê²° ë  ê²ƒì…ë‹ˆë‹¤.

> [ESMê³¼ CommonJSì˜ ì°¨ì´](https://velog.io/@kakasoo/ESM%EA%B3%BC-CommonJS%EC%9D%98-%EC%B0%A8%EC%9D%B4)

fecthë¥¼ ì‚¬ìš©í•˜ì—¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ë©´ ëœë‹¤.

userController.js

```js
export const finishGithubLogin = async (req, res) => {
  const baseUrl = "https://github.com/login/oauth/access_token";
  const config = {
    client_id: process.env.GH_CLIENT,
    client_secret: process.env.GH_CLIENT,
    code: req.query.code,
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
  const data = await fetch(finalUrl, {
    method: "POST",
    headers: {
      Accept: "application / json",
    },
  });
  const json = await data.json();
  console.log(json);
  res.send(JSON.stringify(json));
};
```

> ì—¬ê¸°ì„œ headersëŠ” [HTTP í—¤ë”](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers)ë¥¼ ì˜ë¯¸í•œë‹¤.

ì‹¤í–‰ ì‹œì¼œë³´ë©´ console.logëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤.

![Back end AccessToken](./screenshot/Back-end-accesstoken.png)

Front endìª½ì„ í™•ì¸í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

![Front end AccessToken](./screenshot/Front%20end%20AccessToken.png)

#### 5.4.2 API ì ‘ê·¼

ì´ì œ **access_token**ì„ ê°–ê³  **APIì— ì ‘ê·¼**í•˜ëŠ” ë‹¨ê³„ì´ë‹¤.

JSONì— ìˆëŠ” access_tokenì„ ê°€ì§€ê³  ì˜¤ì.

userController.js

```js
const { access_token } = json;
const userRequest = await fetch("https://api.github.com/user", {
  headers: {
    Authorization: `token ${access_token}`,
  },
});
```

access_tokenì„ JSONìœ¼ë¡œë¶€í„° êº¼ë‚´ì„œ, headersì— authorizationì— ë³´ë‚´ì¤˜ì•¼ í•œë‹¤.

ì´ì™€ ê°™ì´í•˜ë©´ ì½”ë“œ ì¤‘ë³µì´ ë‚˜ë¯€ë¡œ ì½”ë“œ ì¤‘ë³µì„ ì¤„ì´ê³ , access_tokenì´ ì•ˆë“¤ì–´ìˆëŠ” ìƒí™©ì„ ê³ ë ¤í•´ ì¡°ê±´ë¬¸ì„ ì¶”ê°€í•´ì¤€ë‹¤.

userController.js

```js
export const finishGithubLogin = async (req, res) => {
  const baseUrl = "https://github.com/login/oauth/access_token";
  const config = {
    client_id: process.env.GH_CLIENT,
    client_secret: process.env.GH_SECRET,
    code: req.query.code,
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
  const tokenRequest = await (
    await fetch(finalUrl, {
      method: "POST",
      headers: {
        Accept: "application/json",
      },
    })
  ).json();
  console.log(tokenRequest);
  if ("access_token" in tokenRequest) {
    const { access_token } = tokenRequest;
    const userRequest = await (
      await fetch("https://api.github.com/user", {
        headers: {
          Authorization: `token ${access_token}`,
        },
      })
    ).json();
    console.log(userRequest);
  } else {
    return res.redirect("/login");
  }
};
```

ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

**tokenRequest**
![tokenRequest](./screenshot/tokenRequest.png)

**userRequest**
![userRequest](./screenshot/userRequest.png)

ì—¬ê¸°ì„œ ë³´ë©´ scopeì—ëŠ” **user:email**ì´ ì‘ì„±ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì§€ë§Œ userRequestë¥¼ ë³´ë©´ **email: null**ì¸ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¶„ëª… scopeì— ì ì€ ë‚´ìš©ì— ëŒ€í•´ì„œëŠ” ì •ë³´ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤ê³  í–ˆë‹¤.

**_ì™œ ì´ëŸ° ìƒí™©ì´ ë‚˜ì˜¨ ê²ƒì¼ê¹Œ?_**

ì´ëŠ” access_tokenì´ í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ ì¤˜ì•¼ í•˜ëŠ”ë° í•˜ì§€ ì•Šì•„ì„œ ê·¸ë ‡ë‹¤. ì¦‰, í˜„ì¬ access_tokenì„ ê°€ì§€ê³  í•œ ê²ƒì€ **ì²«ë²ˆì§¸ scope**ì¸ **read:user**ë§Œì„ í•˜ê³  ìˆë˜ ê²ƒì´ë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ í•´ë³´ê³  ê²°ê³¼ë¥¼ í™•ì¸í•´ ë³´ì.

```js
const userData = await (
  await fetch("https://api.github.com/user", {
    headers: {
      Authorization: `token ${access_token}`,
    },
  })
).json();
console.log(userData);

if ("access_token" in tokenRequest) {
const { access_token } = tokenRequest;
const emailData = await (
  await fetch(`${apiUrl}/user/emails`, {
    headers: {
      Authorization: `token ${access_token}`,
    },
  })
).json();
```

![Email Data](./screenshot/email-Data.png)

ì—¬ê¸°ì„œ email **verifed**ì´ë©´ì„œ **primary**ì¸ ê²ƒë“¤ë¡œ ì°¾ì•„ì•¼ í•˜ëŠ” ê²ƒì´ë‹¤.

```js
const emailObj = emailData.find(
  (email) => email.primary === true && email.verified === true
);
```

ì½”ë“œë¥¼ ì™„ì„± ì‹œí‚¤ê¸° ì „ì—, ê³ ë ¤í•´ì•¼ ë  ê²½ìš°ê°€ ë‘ ê°€ì§€ê°€ ì¡´ì¬í•œë‹¤.

í˜„ì¬ëŠ” ê³„ì • IDì™€ Passwordë¥¼ ë°›ëŠ” í˜•ì‹ìœ¼ë¡œ Schemaê°€ ë§Œë“¤ì–´ì ¸ ìˆë‹¤. í•˜ì§€ë§Œ, ì†Œì…œ ë¡œê·¸ì¸ì„ í†µí•´ ë¡œê·¸ì¸ì„ í•˜ëŠ” ë°©ì‹ì€ Passwordê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì¦‰,

- ìš°ë¦¬ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ê³„ì • ID, Passwordì™€ emailì„ ì…ë ¥í•˜ì—¬ ê³„ì •ì„ ìƒì„±í•˜ëŠ” ë°©ë²•
- ì†Œì…œë¡œê·¸ì¸ì„ í†µí•´ emailë¡œë§Œ ë¡œê·¸ì¸ í•˜ëŠ” ë°©ë²•

ì´ë ‡ê²Œ ë‘ê°€ì§€ ë°©ì‹ì´ ì¡´ì¬í•˜ëŠ” ê²ƒì´ë‹¤.

ê·¸ëŸ°ë° ë§Œì•½ ì—¬ê¸°ì„œ, **_ìš°ë¦¬ ì›¹ì‚¬ì´íŠ¸ì—ì„œ ìƒì„±í•œ ê³„ì •ì´ DBì— ì¡´ì¬í•˜ëŠ”ë°, ì†Œì…œ ë¡œê·¸ì¸ì„ í†µí•´ ë¡œê·¸ì¸ì„ í•˜ë ¤ë©´?_**

ì´ë•Œ, **ê³„ì •ì„ ìƒˆë¡œ ë§Œë“¤ìˆ˜ë„ ìˆê³ **, ì•„ë‹ˆë©´ **ê³„ì •ì„ ì—°ë™ì‹œì¼œì£¼ëŠ”** ë‘ ê°€ì§€ ìƒí™©ì´ ì¡´ì¬í•œë‹¤.

ìš°ë¦¬ëŠ” **ê³„ì •ì„ ì—°ë™ì‹œì¼œì¤€ë‹¤ê³  ìƒê°í•˜ê³  ì²˜ë¦¬ë¥¼ í•´ì£¼ì.**

ë§ˆì§€ë§‰ìœ¼ë¡œ ì •ë¦¬í•˜ìë©´,

1. ìœ ì €ë¥¼ Githubë¡œ ë³´ë‚´ì£¼ê³  ì¸ì¦ì„ ë°›ìœ¼ë©´ Tokenê³¼ í•¨ê»˜ ì›¹ì‚¬ì´íŠ¸ë¡œ ë„˜ì–´ì˜¨ë‹¤.
2. ë°›ì€ Tokenì„ access_tokenìœ¼ë¡œ ë°”ê¾¼í›„ì— userDataì™€ emailDataë¥¼ ë½‘ì•„ì¤€ë‹¤.
3. ë°›ì€ Dataë¥¼ ì´ìš©í•´ì„œ ë‘ ê°€ì§€ ê²½ìš°ë¡œ êµ¬ë¶„ì„ í•˜ì—¬ Login í˜¹ì€ ê³„ì • ìƒì„±í›„ ë¡œê·¸ì¸ì„ ì§„í–‰í•˜ì—¬ ë§ˆë¬´ë¦¬ë¥¼ ì§“ëŠ”ë‹¤.

ê·¸ê²ƒì„ êµ¬í˜„í•œ ê²ƒì´ ë‹¤ìŒì˜ ì½”ë“œë‹¤.

userController.js

```js
export const finishGithubLogin = async (req, res) => {
  const baseUrl = "https://github.com/login/oauth/access_token";
  const config = {
    client_id: process.env.GH_CLIENT,
    client_secret: process.env.GH_SECRET,
    code: req.query.code,
  };
  const params = new URLSearchParams(config).toString();
  const finalUrl = `${baseUrl}?${params}`;
  const tokenRequest = await (
    await fetch(finalUrl, {
      method: "POST",
      headers: {
        Accept: "application/json",
      },
    })
  ).json();
  if ("access_token" in tokenRequest) {
    const { access_token } = tokenRequest;
    const apiUrl = "https://api.github.com";
    const userData = await (
      await fetch(`${apiUrl}/user`, {
        headers: {
          Authorization: `token ${access_token}`,
        },
      })
    ).json();
    const emailData = await (
      await fetch(`${apiUrl}/user/emails`, {
        headers: {
          Authorization: `token ${access_token}`,
        },
      })
    ).json();
    const emailObj = emailData.find(
      (email) => email.primary === true && email.verified === true
    );
    if (!emailObj) {
      return res.redirect("/login");
    }
    let user = await User.findOne({ email: emailObj.email });
    if (!user) {
      user = await User.create({
        name: userData.name,
        username: userData.login,
        email: emailObj.email,
        password: "",
        socialOnly: true,
        location: userData.location,
      });
    }
    req.session.loggedIn = true;
    req.session.user = user;
    return res.redirect("/");
  } else {
    return res.redirect("/login");
  }
};
```

í˜„ì¬ ë³´ë©´, **emailObjê°€ ì—†ìœ¼ë©´** login pageë¡œ redirectì‹œì¼œì£¼ê³  ìˆë‹¤. ë˜, **findOne()** ì„ ì´ìš©í•´ì„œ **emailì´ Databaseì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸**ì„ í•˜ê³  existingUserì— True í˜¹ì€ Falseë¥¼ ë„£ì–´ì£¼ëŠ” ê²ƒì´ ë³´ì¸ë‹¤. **Trueì´ë©´ ê·¸ëŒ€ë¡œ ë¡œê·¸ì¸**ì„ ì‹œì¼œì£¼ê³ , **Falseë¼ë©´ ê³„ì •ì„ ìƒì„±**í•´ì¤˜ì•¼ í•œë‹¤.

## 6. Log Out

Log Outì„ êµ¬í˜„í•˜ëŠ” ê²ƒì€ ê°„ë‹¨í•˜ë‹¤.

1. base.pug ì¦‰, Templatesì— Log Out button(anchor)ë¥¼ êµ¬í˜„í•´ ë†“ëŠ”ë‹¤.
2. í•´ë‹¹ ë§í¬ë¡œ ì´ë™ì„ í–ˆì„ ë•Œ controllerì—ì„œ ë°›ì•„ì„œ sessionì„ íŒŒê´´ì‹œì¼œ ì¤€ë‹¤.

Templatesë¥¼ ìˆ˜ì •í•˜ëŠ” ë¶€ë¶„ì€ ìƒëµí•˜ê³  controllerë§Œ í™•ì¸í•˜ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

```js
export const logout = (req, res) => {
  req.session.destroy();
  return res.redirect("/");
};
```

ì´ë ‡ê²Œ **User-Authentication**ì´ ë§ˆë¬´ë¦¬ê°€ ëœë‹¤.
